# æœåŠ¡ç›‘æ§ä¸é“¾è·¯è¿½è¸ª

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç†è§£ç›‘æ§çš„é‡è¦æ€§
- æŒæ¡Prometheus+Grafana
- äº†è§£é“¾è·¯è¿½è¸ªåŸç†
- ç†Ÿæ‚‰Skywalking/Zipkin
- æŒæ¡æ—¥å¿—æ”¶é›†

## â­ æ ¸å¿ƒå†…å®¹

- **Prometheus** â­â­â­â­â­
- **Grafana** â­â­â­â­â­
- **Skywalking** â­â­â­â­â­
- **ELKæ—¥å¿—** â­â­â­â­
- **å‘Šè­¦** â­â­â­â­

## 1. ç›‘æ§ä½“ç³» â­â­â­â­â­

### ç›‘æ§å±‚æ¬¡

```
åº”ç”¨ç›‘æ§ï¼šJVMã€æ¥å£æ€§èƒ½ã€ä¸šåŠ¡æŒ‡æ ‡ â­â­â­â­â­
ä¸­é—´ä»¶ç›‘æ§ï¼šMySQLã€Redisã€MQ
ç³»ç»Ÿç›‘æ§ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
é“¾è·¯è¿½è¸ªï¼šåˆ†å¸ƒå¼è°ƒç”¨é“¾ â­â­â­â­â­
æ—¥å¿—ç›‘æ§ï¼šé”™è¯¯æ—¥å¿—ã€ä¸šåŠ¡æ—¥å¿— â­â­â­â­â­
```

### ç›‘æ§æŒ‡æ ‡

```
QPSï¼šæ¯ç§’è¯·æ±‚æ•°
RTï¼šå“åº”æ—¶é—´
é”™è¯¯ç‡ï¼šå¤±è´¥è¯·æ±‚æ¯”ä¾‹
å¯ç”¨æ€§ï¼šæœåŠ¡å¯ç”¨æ—¶é—´æ¯”ä¾‹
```

## 2. Prometheus â­â­â­â­â­

### Spring Booté›†æˆ

```xml
<!-- Mavenä¾èµ– -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>
```

### é…ç½®

```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: '*'  # æš´éœ²æ‰€æœ‰ç«¯ç‚¹
  endpoint:
    health:
      show-details: always
    prometheus:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
```

### è‡ªå®šä¹‰æŒ‡æ ‡ â­â­â­â­â­

```java
import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.MeterRegistry;
import io.micrometer.core.instrument.Timer;

@Service
public class UserService {
    
    private final Counter userCreatedCounter;
    private final Timer userQueryTimer;
    
    public UserService(MeterRegistry registry) {
        // è®¡æ•°å™¨ â­â­â­â­â­
        this.userCreatedCounter = Counter.builder("user.created")
            .description("ç”¨æˆ·åˆ›å»ºæ•°é‡")
            .tag("type", "register")
            .register(registry);
        
        // è®¡æ—¶å™¨ â­â­â­â­â­
        this.userQueryTimer = Timer.builder("user.query")
            .description("ç”¨æˆ·æŸ¥è¯¢è€—æ—¶")
            .register(registry);
    }
    
    public void createUser(User user) {
        // ä¸šåŠ¡é€»è¾‘
        userRepository.save(user);
        
        // å¢åŠ è®¡æ•°
        userCreatedCounter.increment();
    }
    
    public User findById(Long id) {
        // è®°å½•è€—æ—¶ â­â­â­â­â­
        return userQueryTimer.record(() -> {
            return userRepository.findById(id).orElse(null);
        });
    }
}
```

### Prometheusé…ç½®

```yaml
# prometheus.yml
global:
  scrape_interval: 15s  # æŠ“å–é—´éš”

scrape_configs:
  - job_name: 'spring-boot-app'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['localhost:8080']
```

### å¸¸ç”¨PromQL â­â­â­â­â­

```promql
# HTTPè¯·æ±‚æ€»æ•°
http_server_requests_seconds_count

# å¹³å‡å“åº”æ—¶é—´
rate(http_server_requests_seconds_sum[5m]) / rate(http_server_requests_seconds_count[5m])

# QPS
rate(http_server_requests_seconds_count[1m])

# é”™è¯¯ç‡
rate(http_server_requests_seconds_count{status=~"5.."}[5m]) / rate(http_server_requests_seconds_count[5m])

# JVMå†…å­˜ä½¿ç”¨
jvm_memory_used_bytes{area="heap"}

# CPUä½¿ç”¨ç‡
process_cpu_usage
```

## 3. Grafana â­â­â­â­â­

### å®‰è£…

```bash
# Dockeræ–¹å¼
docker run -d \
  --name=grafana \
  -p 3000:3000 \
  grafana/grafana
```

### é…ç½®æ•°æ®æº

```
1. è®¿é—® http://localhost:3000
2. é»˜è®¤è´¦å·ï¼šadmin/admin
3. Configuration -> Data Sources -> Add data source
4. é€‰æ‹©Prometheus
5. URL: http://prometheus:9090
6. Save & Test
```

### å¸¸ç”¨é¢æ¿

```
JVMç›‘æ§é¢æ¿ï¼š4701
Spring Bootç›‘æ§ï¼š11378
MySQLç›‘æ§ï¼š7362
Redisç›‘æ§ï¼š11835
```

## 4. Skywalking â­â­â­â­â­

### ä»€ä¹ˆæ˜¯é“¾è·¯è¿½è¸ªï¼Ÿ

```
åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªè¯·æ±‚å¯èƒ½ç»è¿‡å¤šä¸ªæœåŠ¡
é“¾è·¯è¿½è¸ªå¯ä»¥ï¼š
1. è¿½è¸ªè¯·æ±‚è·¯å¾„
2. åˆ†ææ€§èƒ½ç“¶é¢ˆ
3. å®šä½é”™è¯¯æ¥æº
```

### Spring Booté›†æˆ

```xml
<!-- æ— éœ€æ·»åŠ ä¾èµ–ï¼Œä½¿ç”¨Agentæ–¹å¼ -->
```

### å¯åŠ¨åº”ç”¨

```bash
# ä¸‹è½½Skywalking Agent
wget https://archive.apache.org/dist/skywalking/java-agent/8.16.0/apache-skywalking-java-agent-8.16.0.tgz
tar -zxvf apache-skywalking-java-agent-8.16.0.tgz

# å¯åŠ¨åº”ç”¨ â­â­â­â­â­
java -javaagent:/path/to/skywalking-agent/skywalking-agent.jar \
  -Dskywalking.agent.service_name=my-app \
  -Dskywalking.collector.backend_service=localhost:11800 \
  -jar myapp.jar
```

### è‡ªå®šä¹‰Trace â­â­â­â­

```java
import org.apache.skywalking.apm.toolkit.trace.Trace;
import org.apache.skywalking.apm.toolkit.trace.TraceContext;

@Service
public class UserService {
    
    // è‡ªå®šä¹‰Trace â­â­â­â­â­
    @Trace
    public User findById(Long id) {
        // æ·»åŠ Tag
        TraceContext.putCorrelation("userId", String.valueOf(id));
        
        return userRepository.findById(id).orElse(null);
    }
}
```

## 5. Zipkin â­â­â­â­

### Spring Cloudé›†æˆ

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-zipkin</artifactId>
</dependency>
```

### é…ç½®

```yaml
spring:
  zipkin:
    base-url: http://localhost:9411
  sleuth:
    sampler:
      probability: 1.0  # é‡‡æ ·ç‡100%
```

## 6. ELKæ—¥å¿—æ”¶é›† â­â­â­â­

### Logbacké…ç½®

```xml
<!-- logback-spring.xml -->
<configuration>
    <appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
        <destination>localhost:5000</destination>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <customFields>{"app":"my-app"}</customFields>
        </encoder>
    </appender>
    
    <root level="INFO">
        <appender-ref ref="LOGSTASH"/>
    </root>
</configuration>
```

### Docker Composeéƒ¨ç½²ELK

```yaml
version: '3'
services:
  elasticsearch:
    image: elasticsearch:8.11.0
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
  
  logstash:
    image: logstash:8.11.0
    ports:
      - "5000:5000"
    volumes:
      - ./logstash.conf:/usr/share/logstash/pipeline/logstash.conf
  
  kibana:
    image: kibana:8.11.0
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
```

## 7. å‘Šè­¦ â­â­â­â­

### Prometheuså‘Šè­¦è§„åˆ™

```yaml
# alert.rules.yml
groups:
  - name: example
    rules:
      # æœåŠ¡å®•æœºå‘Šè­¦ â­â­â­â­â­
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "æœåŠ¡{{ $labels.instance }}å®•æœº"
      
      # é«˜é”™è¯¯ç‡å‘Šè­¦ â­â­â­â­â­
      - alert: HighErrorRate
        expr: rate(http_server_requests_seconds_count{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "é”™è¯¯ç‡è¿‡é«˜"
      
      # é«˜å“åº”æ—¶é—´å‘Šè­¦
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_server_requests_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "95åˆ†ä½å“åº”æ—¶é—´è¶…è¿‡1ç§’"
```

### é’‰é’‰å‘Šè­¦

```java
@Component
public class DingTalkAlertService {
    
    private final RestTemplate restTemplate;
    private final String webhookUrl = "https://oapi.dingtalk.com/robot/send?access_token=xxx";
    
    public void sendAlert(String message) {
        DingTalkMessage msg = new DingTalkMessage();
        msg.setMsgtype("text");
        msg.setText(new Text(message));
        
        restTemplate.postForObject(webhookUrl, msg, String.class);
    }
}
```

## 8. å®Œæ•´ç›‘æ§æ–¹æ¡ˆ â­â­â­â­â­

### Spring Bootåº”ç”¨é…ç½®

```yaml
# application.yml
spring:
  application:
    name: my-app
  
  # Zipkiné“¾è·¯è¿½è¸ª
  zipkin:
    base-url: http://zipkin:9411
  sleuth:
    sampler:
      probability: 1.0

# Actuatorç›‘æ§
management:
  endpoints:
    web:
      exposure:
        include: '*'
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
      env: ${spring.profiles.active}

# æ—¥å¿—
logging:
  level:
    root: INFO
    com.example: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

### Docker Composeå®Œæ•´æ–¹æ¡ˆ

```yaml
version: '3'
services:
  # åº”ç”¨
  app:
    image: my-app:1.0
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
  
  # Prometheus
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
  
  # Grafana
  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
  
  # Skywalking OAP
  skywalking-oap:
    image: apache/skywalking-oap-server:9.5.0
    ports:
      - "11800:11800"
      - "12800:12800"
  
  # Skywalking UI
  skywalking-ui:
    image: apache/skywalking-ui:9.5.0
    ports:
      - "8081:8080"
    environment:
      - SW_OAP_ADDRESS=http://skywalking-oap:12800
```

## ğŸ’¡ æœ€ä½³å®è·µ â­â­â­â­â­

### 1. ç›‘æ§æŒ‡æ ‡è®¾è®¡

```java
// ä¸šåŠ¡æŒ‡æ ‡
Counter orderCounter = Counter.builder("order.created")
    .tag("type", "online")
    .register(registry);

// æ€§èƒ½æŒ‡æ ‡
Timer paymentTimer = Timer.builder("payment.process")
    .register(registry);

// èµ„æºæŒ‡æ ‡
Gauge.builder("cache.size", cache, Cache::size)
    .register(registry);
```

### 2. æ—¥å¿—è§„èŒƒ

```java
// ä½¿ç”¨ç»“æ„åŒ–æ—¥å¿—
log.info("ç”¨æˆ·ç™»å½•æˆåŠŸ, userId={}, ip={}", userId, ip);

// ä¸è¦æ‰“å°æ•æ„Ÿä¿¡æ¯
log.info("ç”¨æˆ·ä¿¡æ¯: {}", user.toString());  // ç¡®ä¿toStringä¸åŒ…å«å¯†ç 

// å¼‚å¸¸æ—¥å¿—
log.error("å¤„ç†è®¢å•å¤±è´¥, orderId={}", orderId, e);
```

### 3. å‘Šè­¦ç­–ç•¥

```
P0ï¼ˆç´§æ€¥ï¼‰ï¼šæœåŠ¡å®•æœºã€æ•°æ®ä¸¢å¤± - ç«‹å³å¤„ç†
P1ï¼ˆé‡è¦ï¼‰ï¼šé«˜é”™è¯¯ç‡ã€æ€§èƒ½ä¸‹é™ - 30åˆ†é’Ÿå†…å¤„ç†
P2ï¼ˆä¸€èˆ¬ï¼‰ï¼šèµ„æºä½¿ç”¨ç‡é«˜ - 2å°æ—¶å†…å¤„ç†
P3ï¼ˆæç¤ºï¼‰ï¼šä¼˜åŒ–å»ºè®® - å·¥ä½œæ—¶é—´å¤„ç†
```

## ğŸ¯ å®æˆ˜ç»ƒä¹ 

1. æ­å»ºPrometheus+Grafanaç›‘æ§ç³»ç»Ÿ
2. é›†æˆSkywalkingé“¾è·¯è¿½è¸ª
3. é…ç½®å‘Šè­¦è§„åˆ™
4. æ­å»ºELKæ—¥å¿—ç³»ç»Ÿ

## ğŸ“š ä¸‹ä¸€æ­¥

å­¦ä¹ å®Œç›‘æ§åï¼Œç»§ç»­å­¦ä¹ ï¼š
- [Kuberneteså…¥é—¨](./Kuberneteså…¥é—¨.md)
- [é¡¹ç›®å®æˆ˜](../06-é¡¹ç›®å®æˆ˜/é¡¹ç›®å®æˆ˜.md)

