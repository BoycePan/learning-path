# åˆ†å¸ƒå¼æŠ€æœ¯

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç†è§£åˆ†å¸ƒå¼ç³»ç»Ÿæ ¸å¿ƒæ¦‚å¿µ
- æŒæ¡åˆ†å¸ƒå¼é”
- äº†è§£åˆ†å¸ƒå¼IDç”Ÿæˆ
- ç†è§£åˆ†å¸ƒå¼ç¼“å­˜
- äº†è§£åˆ†å¸ƒå¼å­˜å‚¨

## â­ åˆ†å¸ƒå¼æ ¸å¿ƒé—®é¢˜

- **åˆ†å¸ƒå¼é”** â­â­â­â­â­
- **åˆ†å¸ƒå¼ID** â­â­â­â­â­
- **åˆ†å¸ƒå¼ç¼“å­˜** â­â­â­â­â­
- **åˆ†å¸ƒå¼äº‹åŠ¡** â­â­â­â­â­
- **CAPç†è®º** â­â­â­â­â­

## 1. åˆ†å¸ƒå¼é” â­â­â­â­â­

### Rediså®ç°

```java
/**
 * Redisåˆ†å¸ƒå¼é” â­â­â­â­â­
 */
@Service
public class RedisLockService {

    @Autowired
    private StringRedisTemplate redisTemplate;

    /**
     * è·å–é”
     */
    public boolean tryLock(String key, String value, long timeout) {
        Boolean success = redisTemplate.opsForValue()
            .setIfAbsent(key, value, timeout, TimeUnit.SECONDS);
        return Boolean.TRUE.equals(success);
    }

    /**
     * é‡Šæ”¾é”ï¼ˆLuaè„šæœ¬ä¿è¯åŸå­æ€§ï¼‰
     */
    public boolean unlock(String key, String value) {
        String script =
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "return redis.call('del', KEYS[1]) else return 0 end";

        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(script, Long.class),
            Collections.singletonList(key),
            value
        );

        return Long.valueOf(1).equals(result);
    }
}
```

### Redissonå®ç°ï¼ˆæ¨èï¼‰

```java
/**
 * Redissonåˆ†å¸ƒå¼é” â­â­â­â­â­
 */
@Service
public class RedissonLockService {

    @Autowired
    private RedissonClient redissonClient;

    public void executeWithLock(String lockKey, Runnable task) {
        RLock lock = redissonClient.getLock(lockKey);

        try {
            // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…10ç§’ï¼Œé”30ç§’åè‡ªåŠ¨é‡Šæ”¾
            if (lock.tryLock(10, 30, TimeUnit.SECONDS)) {
                task.run();
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
```

## 2. åˆ†å¸ƒå¼ID â­â­â­â­â­

### é›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰

```java
/**
 * é›ªèŠ±ç®—æ³•IDç”Ÿæˆå™¨ â­â­â­â­â­
 *
 * 64ä½Longå‹IDï¼š
 * 1ä½ç¬¦å·ä½ + 41ä½æ—¶é—´æˆ³ + 10ä½æœºå™¨ID + 12ä½åºåˆ—å·
 */
public class SnowflakeIdGenerator {
    private final long workerId;
    private final long datacenterId;
    private long sequence = 0L;
    private long lastTimestamp = -1L;

    public SnowflakeIdGenerator(long workerId, long datacenterId) {
        this.workerId = workerId;
        this.datacenterId = datacenterId;
    }

    public synchronized long nextId() {
        long timestamp = System.currentTimeMillis();

        // æ—¶é’Ÿå›æ‹¨
        if (timestamp < lastTimestamp) {
            throw new RuntimeException("æ—¶é’Ÿå›æ‹¨å¼‚å¸¸");
        }

        // åŒä¸€æ¯«ç§’å†…
        if (timestamp == lastTimestamp) {
            sequence = (sequence + 1) & 4095;  // 4095 = 2^12 - 1
            if (sequence == 0) {
                timestamp = tilNextMillis(lastTimestamp);
            }
        } else {
            sequence = 0L;
        }

        lastTimestamp = timestamp;

        return ((timestamp - 1609459200000L) << 22)  // æ—¶é—´æˆ³éƒ¨åˆ†
            | (datacenterId << 17)                    // æ•°æ®ä¸­å¿ƒID
            | (workerId << 12)                        // æœºå™¨ID
            | sequence;                               // åºåˆ—å·
    }

    private long tilNextMillis(long lastTimestamp) {
        long timestamp = System.currentTimeMillis();
        while (timestamp <= lastTimestamp) {
            timestamp = System.currentTimeMillis();
        }
        return timestamp;
    }
}
```

### æ•°æ®åº“è‡ªå¢ID

```sql
-- ä¼˜ç‚¹ï¼šç®€å•
-- ç¼ºç‚¹ï¼šæ€§èƒ½ç“¶é¢ˆã€å•ç‚¹æ•…éšœ

CREATE TABLE id_generator (
    id BIGINT PRIMARY KEY AUTO_INCREMENT
) ENGINE=InnoDB;
```

### Redisç”ŸæˆID

```java
/**
 * Redisè‡ªå¢ID â­â­â­â­
 */
public long generateId(String key) {
    return redisTemplate.opsForValue().increment(key);
}
```

## 3. åˆ†å¸ƒå¼ç¼“å­˜ â­â­â­â­â­

### ç¼“å­˜ä¸€è‡´æ€§

```java
/**
 * Cache Asideæ¨¡å¼ â­â­â­â­â­
 */
@Service
public class UserCacheService {

    @Autowired
    private UserMapper userMapper;

    @Autowired
    private StringRedisTemplate redisTemplate;

    /**
     * æŸ¥è¯¢
     */
    public User getById(Long id) {
        String key = "user:" + id;

        // 1. æŸ¥ç¼“å­˜
        String json = redisTemplate.opsForValue().get(key);
        if (json != null) {
            return JSON.parseObject(json, User.class);
        }

        // 2. æŸ¥æ•°æ®åº“
        User user = userMapper.selectById(id);

        // 3. å†™ç¼“å­˜
        if (user != null) {
            redisTemplate.opsForValue().set(
                key,
                JSON.toJSONString(user),
                1,
                TimeUnit.HOURS
            );
        }

        return user;
    }

    /**
     * æ›´æ–°ï¼ˆå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ï¼‰â­â­â­â­â­
     */
    public void update(User user) {
        // 1. æ›´æ–°æ•°æ®åº“
        userMapper.updateById(user);

        // 2. åˆ é™¤ç¼“å­˜
        String key = "user:" + user.getId();
        redisTemplate.delete(key);
    }
}
```

### ç¼“å­˜ç©¿é€/å‡»ç©¿/é›ªå´©

```java
/**
 * ç¼“å­˜ç©¿é€ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ® â­â­â­â­â­
 * è§£å†³ï¼šç¼“å­˜ç©ºå€¼ã€å¸ƒéš†è¿‡æ»¤å™¨
 */
public User getByIdWithBloomFilter(Long id) {
    // å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­
    if (!bloomFilter.mightContain(id)) {
        return null;
    }

    // æ­£å¸¸æŸ¥è¯¢æµç¨‹
    return getById(id);
}

/**
 * ç¼“å­˜å‡»ç©¿ï¼šçƒ­ç‚¹keyè¿‡æœŸ â­â­â­â­â­
 * è§£å†³ï¼šäº’æ–¥é”ã€çƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ
 */
public User getByIdWithLock(Long id) {
    String key = "user:" + id;
    String lockKey = "lock:" + key;

    // 1. æŸ¥ç¼“å­˜
    String json = redisTemplate.opsForValue().get(key);
    if (json != null) {
        return JSON.parseObject(json, User.class);
    }

    // 2. è·å–é”
    Boolean locked = redisTemplate.opsForValue()
        .setIfAbsent(lockKey, "1", 10, TimeUnit.SECONDS);

    if (Boolean.TRUE.equals(locked)) {
        try {
            // 3. åŒé‡æ£€æŸ¥
            json = redisTemplate.opsForValue().get(key);
            if (json != null) {
                return JSON.parseObject(json, User.class);
            }

            // 4. æŸ¥æ•°æ®åº“
            User user = userMapper.selectById(id);

            // 5. å†™ç¼“å­˜
            if (user != null) {
                redisTemplate.opsForValue().set(
                    key,
                    JSON.toJSONString(user),
                    1,
                    TimeUnit.HOURS
                );
            }

            return user;
        } finally {
            redisTemplate.delete(lockKey);
        }
    } else {
        // ç­‰å¾…åé‡è¯•
        try {
            Thread.sleep(50);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        return getByIdWithLock(id);
    }
}

/**
 * ç¼“å­˜é›ªå´©ï¼šå¤§é‡keyåŒæ—¶è¿‡æœŸ â­â­â­â­â­
 * è§£å†³ï¼šè¿‡æœŸæ—¶é—´åŠ éšæœºå€¼
 */
public void setWithRandomExpire(String key, String value) {
    long expire = 3600 + ThreadLocalRandom.current().nextInt(600);
    redisTemplate.opsForValue().set(key, value, expire, TimeUnit.SECONDS);
}
```

## 4. CAPç†è®º â­â­â­â­â­

```
CAPå®šç†ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿåªèƒ½åŒæ—¶æ»¡è¶³ä¸¤ä¸ª

Cï¼ˆConsistencyï¼‰- ä¸€è‡´æ€§
Aï¼ˆAvailabilityï¼‰- å¯ç”¨æ€§
Pï¼ˆPartition Toleranceï¼‰- åˆ†åŒºå®¹é”™æ€§

å¸¸è§ç»„åˆï¼š
- CPï¼šå¼ºä¸€è‡´æ€§ï¼ˆå¦‚ZooKeeperã€HBaseï¼‰
- APï¼šé«˜å¯ç”¨æ€§ï¼ˆå¦‚Eurekaã€Cassandraï¼‰
- CAï¼šå•æœºç³»ç»Ÿï¼ˆå¦‚MySQLå•æœºï¼‰

å¾®æœåŠ¡é€šå¸¸é€‰æ‹©APï¼Œä¿è¯å¯ç”¨æ€§
é€šè¿‡æœ€ç»ˆä¸€è‡´æ€§ä¿è¯æ•°æ®ä¸€è‡´
```

## ğŸ’¡ é‡ç‚¹æ€»ç»“

### åˆ†å¸ƒå¼æŠ€æœ¯é€‰å‹

| æŠ€æœ¯       | å·¥å…·      | æ¨èåº¦     | è¯¦ç»†æ–‡æ¡£                |
| ---------- | --------- | ---------- | ----------------------- |
| åˆ†å¸ƒå¼é”   | Redisson  | â­â­â­â­â­ | -                       |
| åˆ†å¸ƒå¼ID   | Snowflake | â­â­â­â­â­ | -                       |
| åˆ†å¸ƒå¼ç¼“å­˜ | Redis     | â­â­â­â­â­ | -                       |
| åˆ†å¸ƒå¼äº‹åŠ¡ | Seata     | â­â­â­â­â­ | [Seataè¯¦è§£](./Seata.md) |
| é…ç½®ä¸­å¿ƒ   | Nacos     | â­â­â­â­â­ | -                       |
| æ³¨å†Œä¸­å¿ƒ   | Nacos     | â­â­â­â­â­ | -                       |

## ğŸ¯ ç»ƒä¹ å»ºè®®

1. å®ç°Redisåˆ†å¸ƒå¼é”
2. å®ç°é›ªèŠ±ç®—æ³•IDç”Ÿæˆ
3. å®ç°ä¸‰çº§ç¼“å­˜æ¶æ„
4. ç†è§£CAPç†è®º

## ğŸ“š ä¸‹ä¸€æ­¥

å®Œæˆå¾®æœåŠ¡ä¸ä¸­é—´ä»¶å­¦ä¹ åï¼Œè¿›å…¥ [é¡¹ç›®å®æˆ˜](../06-é¡¹ç›®å®æˆ˜/)
