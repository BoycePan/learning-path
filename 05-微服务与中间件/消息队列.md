# æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç†è§£æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨åœºæ™¯
- æŒæ¡RocketMQä½¿ç”¨
- äº†è§£KafkaåŸºç¡€
- ç†è§£æ¶ˆæ¯å¯é æ€§ä¿è¯

## â­ æ¶ˆæ¯é˜Ÿåˆ—æ ¸å¿ƒæ¦‚å¿µ

- **å¼‚æ­¥è§£è€¦** â­â­â­â­â­
- **å‰Šå³°å¡«è°·** â­â­â­â­â­
- **æ¶ˆæ¯å¯é æ€§** â­â­â­â­â­
- **é¡ºåºæ¶ˆæ¯** â­â­â­â­
- **äº‹åŠ¡æ¶ˆæ¯** â­â­â­â­â­

## 1. RocketMQå¿«é€Ÿå¼€å§‹ â­â­â­â­â­

### Mavenä¾èµ–

```xml
<dependency>
    <groupId>org.apache.rocketmq</groupId>
    <artifactId>rocketmq-spring-boot-starter</artifactId>
    <version>2.2.3</version>
</dependency>
```

### é…ç½®

```yaml
# application.yml
rocketmq:
  name-server: localhost:9876
  producer:
    group: my-producer-group
    send-message-timeout: 3000
```

### ç”Ÿäº§è€…

```java
/**
 * å‘é€æ¶ˆæ¯ â­â­â­â­â­
 */
@Service
public class ProducerService {
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    /**
     * åŒæ­¥å‘é€
     */
    public void sendSync(String topic, String message) {
        SendResult result = rocketMQTemplate.syncSend(topic, message);
        System.out.println("å‘é€ç»“æœï¼š" + result.getSendStatus());
    }
    
    /**
     * å¼‚æ­¥å‘é€
     */
    public void sendAsync(String topic, String message) {
        rocketMQTemplate.asyncSend(topic, message, new SendCallback() {
            @Override
            public void onSuccess(SendResult result) {
                System.out.println("å‘é€æˆåŠŸ");
            }
            
            @Override
            public void onException(Throwable e) {
                System.out.println("å‘é€å¤±è´¥ï¼š" + e.getMessage());
            }
        });
    }
    
    /**
     * å•å‘å‘é€ï¼ˆä¸å…³å¿ƒç»“æœï¼‰
     */
    public void sendOneWay(String topic, String message) {
        rocketMQTemplate.sendOneWay(topic, message);
    }
}
```

### æ¶ˆè´¹è€…

```java
/**
 * æ¶ˆè´¹æ¶ˆæ¯ â­â­â­â­â­
 */
@Component
@RocketMQMessageListener(
    topic = "test-topic",
    consumerGroup = "my-consumer-group"
)
public class MessageConsumer implements RocketMQListener<String> {
    
    @Override
    public void onMessage(String message) {
        System.out.println("æ”¶åˆ°æ¶ˆæ¯ï¼š" + message);
        // å¤„ç†ä¸šåŠ¡é€»è¾‘
    }
}
```

## 2. åº”ç”¨åœºæ™¯ â­â­â­â­â­

### å¼‚æ­¥å¤„ç†

```java
/**
 * ç”¨æˆ·æ³¨å†Œ - å¼‚æ­¥å‘é€é‚®ä»¶/çŸ­ä¿¡ â­â­â­â­â­
 */
@Service
public class UserService {
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    public void register(User user) {
        // 1. ä¿å­˜ç”¨æˆ·
        userMapper.insert(user);
        
        // 2. å¼‚æ­¥å‘é€æ¬¢è¿é‚®ä»¶
        rocketMQTemplate.asyncSend("email-topic", user.getEmail());
        
        // 3. å¼‚æ­¥å‘é€çŸ­ä¿¡
        rocketMQTemplate.asyncSend("sms-topic", user.getPhone());
        
        // ä¸ç”¨ç­‰å¾…é‚®ä»¶ã€çŸ­ä¿¡å‘é€å®Œæˆ
    }
}
```

### æµé‡å‰Šå³°

```java
/**
 * ç§’æ€åœºæ™¯ - å‰Šå³°å¡«è°· â­â­â­â­â­
 */
@Service
public class SeckillService {
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    public void seckill(Long userId, Long productId) {
        // å…ˆå°†è¯·æ±‚æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—
        SeckillMessage msg = new SeckillMessage(userId, productId);
        rocketMQTemplate.syncSend("seckill-topic", msg);
        
        // å¼‚æ­¥å¤„ç†ï¼Œé¿å…æ•°æ®åº“ç¬é—´å‹åŠ›è¿‡å¤§
    }
}

@Component
@RocketMQMessageListener(
    topic = "seckill-topic",
    consumerGroup = "seckill-consumer"
)
public class SeckillConsumer implements RocketMQListener<SeckillMessage> {
    
    @Override
    public void onMessage(SeckillMessage message) {
        // æ…¢æ…¢å¤„ç†ç§’æ€è¯·æ±‚
        processSeckill(message.getUserId(), message.getProductId());
    }
}
```

## 3. æ¶ˆæ¯å¯é æ€§ â­â­â­â­â­

### ç”Ÿäº§è€…é‡è¯•

```java
/**
 * å‘é€å¤±è´¥è‡ªåŠ¨é‡è¯• â­â­â­â­â­
 */
rocketMQTemplate.syncSend(
    "topic",
    message,
    3000,  // è¶…æ—¶æ—¶é—´
    3      // é‡è¯•æ¬¡æ•°
);
```

### æ¶ˆè´¹è€…ACK

```java
/**
 * æ¶ˆè´¹ç¡®è®¤ â­â­â­â­â­
 */
@Override
public void onMessage(String message) {
    try {
        // å¤„ç†æ¶ˆæ¯
        processMessage(message);
        // æˆåŠŸåˆ™è‡ªåŠ¨ACK
    } catch (Exception e) {
        // å¤±è´¥åˆ™é‡è¯•
        throw new RuntimeException("å¤„ç†å¤±è´¥", e);
    }
}
```

## 4. KafkaåŸºç¡€ â­â­â­â­â­

### ç‰¹ç‚¹

```
é«˜ååé‡ï¼šç™¾ä¸‡çº§TPS
åˆ†å¸ƒå¼ï¼šå¤©ç„¶æ”¯æŒé›†ç¾¤
æŒä¹…åŒ–ï¼šæ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜
é¡ºåºæ€§ï¼šåˆ†åŒºå†…æœ‰åº

é€‚ç”¨åœºæ™¯ï¼š
- æ—¥å¿—æ”¶é›†
- æµå¼å¤„ç†
- å¤§æ•°æ®åœºæ™¯
```

### åŸºæœ¬ä½¿ç”¨

```java
/**
 * Kafkaç”Ÿäº§è€… â­â­â­â­
 */
@Service
public class KafkaProducerService {
    
    @Autowired
    private KafkaTemplate<String, String> kafkaTemplate;
    
    public void send(String topic, String message) {
        kafkaTemplate.send(topic, message);
    }
}

/**
 * Kafkaæ¶ˆè´¹è€… â­â­â­â­
 */
@Component
public class KafkaConsumerService {
    
    @KafkaListener(topics = "test-topic", groupId = "my-group")
    public void consume(String message) {
        System.out.println("æ”¶åˆ°æ¶ˆæ¯ï¼š" + message);
    }
}
```

## ğŸ’¡ MQé€‰å‹å¯¹æ¯”

| ç‰¹æ€§ | RocketMQ | Kafka | RabbitMQ |
|------|---------|-------|----------|
| ååé‡ | 10ä¸‡+ | 100ä¸‡+ | ä¸‡çº§ |
| æ—¶æ•ˆæ€§ | msçº§ | msçº§ | usçº§ |
| å¯ç”¨æ€§ | é«˜ | é«˜ | é«˜ |
| åŠŸèƒ½ | ä¸°å¯Œ | ç®€å• | ä¸°å¯Œ |
| æ¨èåœºæ™¯ | é€šç”¨ â­â­â­â­â­ | å¤§æ•°æ® | å°è§„æ¨¡ |

## ğŸ¯ ç»ƒä¹ å»ºè®®

1. æ­å»ºRocketMQç¯å¢ƒ
2. å®ç°ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
3. å®ç°è®¢å•å¼‚æ­¥å¤„ç†
4. å®ç°ç§’æ€å‰Šå³°

## ğŸ“š ä¸‹ä¸€æ­¥

ç»§ç»­å­¦ä¹  [åˆ†å¸ƒå¼æŠ€æœ¯](./åˆ†å¸ƒå¼æŠ€æœ¯.md)

