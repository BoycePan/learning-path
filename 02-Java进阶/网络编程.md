# Java网络编程

## 📌 学习目标

- 理解网络编程基础
- 掌握Socket编程
- 了解HTTP客户端
- 熟悉NIO网络编程
- 了解Netty框架

## ⭐ 核心内容

- **Socket编程** ⭐⭐⭐⭐
- **HTTP客户端** ⭐⭐⭐⭐⭐
- **NIO** ⭐⭐⭐⭐
- **Netty** ⭐⭐⭐⭐
- **WebSocket** ⭐⭐⭐⭐

## 1. 网络基础 ⭐⭐⭐⭐⭐

### TCP/IP协议

```
应用层：HTTP, FTP, SMTP
传输层：TCP, UDP ⭐⭐⭐⭐⭐
网络层：IP
数据链路层：以太网
物理层：硬件
```

### TCP vs UDP

| 特性 | TCP | UDP |
|------|-----|-----|
| 连接 | 面向连接 ⭐⭐⭐⭐⭐ | 无连接 |
| 可靠性 | 可靠 ⭐⭐⭐⭐⭐ | 不可靠 |
| 速度 | 慢 | 快 ⭐⭐⭐⭐⭐ |
| 应用 | HTTP, FTP | 视频流, DNS |

## 2. Socket编程 ⭐⭐⭐⭐

### TCP Socket - 服务端 ⭐⭐⭐⭐⭐

```java
import java.net.*;
import java.io.*;

public class TCPServer {
    public static void main(String[] args) {
        try (ServerSocket serverSocket = new ServerSocket(8080)) {
            System.out.println("服务器启动，监听端口8080");
            
            while (true) {
                // 等待客户端连接 ⭐⭐⭐⭐⭐
                Socket clientSocket = serverSocket.accept();
                System.out.println("客户端连接：" + clientSocket.getInetAddress());
                
                // 处理客户端请求（多线程）
                new Thread(() -> handleClient(clientSocket)).start();
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
    
    private static void handleClient(Socket socket) {
        try (
            BufferedReader in = new BufferedReader(
                new InputStreamReader(socket.getInputStream()));
            PrintWriter out = new PrintWriter(socket.getOutputStream(), true)
        ) {
            String message;
            while ((message = in.readLine()) != null) {
                System.out.println("收到消息：" + message);
                out.println("服务器回复：" + message);
                
                if ("bye".equalsIgnoreCase(message)) {
                    break;
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            try {
                socket.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }
}
```

### TCP Socket - 客户端 ⭐⭐⭐⭐⭐

```java
public class TCPClient {
    public static void main(String[] args) {
        try (
            Socket socket = new Socket("localhost", 8080);
            BufferedReader in = new BufferedReader(
                new InputStreamReader(socket.getInputStream()));
            PrintWriter out = new PrintWriter(socket.getOutputStream(), true);
            BufferedReader console = new BufferedReader(
                new InputStreamReader(System.in))
        ) {
            System.out.println("连接到服务器");
            
            String userInput;
            while ((userInput = console.readLine()) != null) {
                // 发送消息 ⭐⭐⭐⭐⭐
                out.println(userInput);
                
                // 接收响应
                String response = in.readLine();
                System.out.println(response);
                
                if ("bye".equalsIgnoreCase(userInput)) {
                    break;
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

### UDP Socket ⭐⭐⭐⭐

```java
// UDP服务端
public class UDPServer {
    public static void main(String[] args) {
        try (DatagramSocket socket = new DatagramSocket(9090)) {
            System.out.println("UDP服务器启动");
            
            byte[] buffer = new byte[1024];
            
            while (true) {
                DatagramPacket packet = new DatagramPacket(buffer, buffer.length);
                socket.receive(packet);  // 接收数据
                
                String message = new String(packet.getData(), 0, packet.getLength());
                System.out.println("收到：" + message);
                
                // 发送响应
                String response = "服务器收到：" + message;
                byte[] responseData = response.getBytes();
                DatagramPacket responsePacket = new DatagramPacket(
                    responseData, responseData.length,
                    packet.getAddress(), packet.getPort()
                );
                socket.send(responsePacket);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}

// UDP客户端
public class UDPClient {
    public static void main(String[] args) {
        try (DatagramSocket socket = new DatagramSocket()) {
            InetAddress address = InetAddress.getByName("localhost");
            
            String message = "Hello UDP";
            byte[] data = message.getBytes();
            
            DatagramPacket packet = new DatagramPacket(
                data, data.length, address, 9090
            );
            socket.send(packet);  // 发送数据
            
            // 接收响应
            byte[] buffer = new byte[1024];
            DatagramPacket responsePacket = new DatagramPacket(buffer, buffer.length);
            socket.receive(responsePacket);
            
            String response = new String(responsePacket.getData(), 
                0, responsePacket.getLength());
            System.out.println(response);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

## 3. HTTP客户端 ⭐⭐⭐⭐⭐

### HttpClient (Java 11+) ⭐⭐⭐⭐⭐

```java
import java.net.http.*;
import java.net.URI;

public class HttpClientDemo {
    public static void main(String[] args) throws Exception {
        // 创建HttpClient ⭐⭐⭐⭐⭐
        HttpClient client = HttpClient.newBuilder()
            .version(HttpClient.Version.HTTP_2)
            .build();
        
        // GET请求 ⭐⭐⭐⭐⭐
        HttpRequest getRequest = HttpRequest.newBuilder()
            .uri(URI.create("https://api.github.com/users/octocat"))
            .GET()
            .build();
        
        HttpResponse<String> getResponse = client.send(
            getRequest, 
            HttpResponse.BodyHandlers.ofString()
        );
        
        System.out.println("状态码：" + getResponse.statusCode());
        System.out.println("响应体：" + getResponse.body());
        
        // POST请求 ⭐⭐⭐⭐⭐
        String json = "{\"name\":\"John\",\"age\":30}";
        HttpRequest postRequest = HttpRequest.newBuilder()
            .uri(URI.create("https://httpbin.org/post"))
            .header("Content-Type", "application/json")
            .POST(HttpRequest.BodyPublishers.ofString(json))
            .build();
        
        HttpResponse<String> postResponse = client.send(
            postRequest,
            HttpResponse.BodyHandlers.ofString()
        );
        
        System.out.println(postResponse.body());
        
        // 异步请求 ⭐⭐⭐⭐⭐
        client.sendAsync(getRequest, HttpResponse.BodyHandlers.ofString())
            .thenApply(HttpResponse::body)
            .thenAccept(System.out::println)
            .join();
    }
}
```

### RestTemplate (Spring) ⭐⭐⭐⭐⭐

```java
import org.springframework.web.client.RestTemplate;

public class RestTemplateDemo {
    public static void main(String[] args) {
        RestTemplate restTemplate = new RestTemplate();
        
        // GET请求 ⭐⭐⭐⭐⭐
        String url = "https://api.github.com/users/octocat";
        User user = restTemplate.getForObject(url, User.class);
        System.out.println(user);
        
        // POST请求 ⭐⭐⭐⭐⭐
        User newUser = new User("John", 30);
        User created = restTemplate.postForObject(
            "https://httpbin.org/post",
            newUser,
            User.class
        );
        
        // PUT请求
        restTemplate.put("https://httpbin.org/put", newUser);
        
        // DELETE请求
        restTemplate.delete("https://httpbin.org/delete");
    }
}
```

### OkHttp ⭐⭐⭐⭐⭐

```java
import okhttp3.*;

public class OkHttpDemo {
    public static void main(String[] args) throws Exception {
        OkHttpClient client = new OkHttpClient();
        
        // GET请求 ⭐⭐⭐⭐⭐
        Request getRequest = new Request.Builder()
            .url("https://api.github.com/users/octocat")
            .build();
        
        try (Response response = client.newCall(getRequest).execute()) {
            System.out.println(response.body().string());
        }
        
        // POST请求 ⭐⭐⭐⭐⭐
        String json = "{\"name\":\"John\",\"age\":30}";
        RequestBody body = RequestBody.create(
            json,
            MediaType.parse("application/json")
        );
        
        Request postRequest = new Request.Builder()
            .url("https://httpbin.org/post")
            .post(body)
            .build();
        
        try (Response response = client.newCall(postRequest).execute()) {
            System.out.println(response.body().string());
        }
    }
}
```

## 4. NIO网络编程 ⭐⭐⭐⭐

### NIO Server ⭐⭐⭐⭐

```java
import java.nio.*;
import java.nio.channels.*;
import java.net.InetSocketAddress;
import java.util.Iterator;

public class NIOServer {
    public static void main(String[] args) throws Exception {
        // 创建Selector ⭐⭐⭐⭐⭐
        Selector selector = Selector.open();
        
        // 创建ServerSocketChannel
        ServerSocketChannel serverChannel = ServerSocketChannel.open();
        serverChannel.bind(new InetSocketAddress(8080));
        serverChannel.configureBlocking(false);  // 非阻塞模式
        
        // 注册到Selector
        serverChannel.register(selector, SelectionKey.OP_ACCEPT);
        
        System.out.println("NIO服务器启动");
        
        while (true) {
            // 等待事件
            selector.select();
            
            Iterator<SelectionKey> keys = selector.selectedKeys().iterator();
            while (keys.hasNext()) {
                SelectionKey key = keys.next();
                keys.remove();
                
                if (key.isAcceptable()) {
                    // 接受连接
                    ServerSocketChannel server = (ServerSocketChannel) key.channel();
                    SocketChannel client = server.accept();
                    client.configureBlocking(false);
                    client.register(selector, SelectionKey.OP_READ);
                    System.out.println("客户端连接");
                    
                } else if (key.isReadable()) {
                    // 读取数据
                    SocketChannel client = (SocketChannel) key.channel();
                    ByteBuffer buffer = ByteBuffer.allocate(1024);
                    int len = client.read(buffer);
                    
                    if (len > 0) {
                        buffer.flip();
                        String message = new String(buffer.array(), 0, len);
                        System.out.println("收到：" + message);
                        
                        // 回复
                        buffer.clear();
                        buffer.put(("服务器回复：" + message).getBytes());
                        buffer.flip();
                        client.write(buffer);
                    }
                }
            }
        }
    }
}
```

## 5. Netty框架 ⭐⭐⭐⭐⭐

### Maven依赖

```xml
<dependency>
    <groupId>io.netty</groupId>
    <artifactId>netty-all</artifactId>
    <version>4.1.104.Final</version>
</dependency>
```

### Netty Server ⭐⭐⭐⭐⭐

```java
import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.*;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;
import io.netty.handler.codec.string.*;

public class NettyServer {
    public static void main(String[] args) throws Exception {
        // Boss线程组：处理连接
        EventLoopGroup bossGroup = new NioEventLoopGroup(1);
        // Worker线程组：处理IO
        EventLoopGroup workerGroup = new NioEventLoopGroup();
        
        try {
            ServerBootstrap bootstrap = new ServerBootstrap();
            bootstrap.group(bossGroup, workerGroup)
                .channel(NioServerSocketChannel.class)
                .childHandler(new ChannelInitializer<SocketChannel>() {
                    @Override
                    protected void initChannel(SocketChannel ch) {
                        ch.pipeline()
                            .addLast(new StringDecoder())
                            .addLast(new StringEncoder())
                            .addLast(new ServerHandler());
                    }
                });
            
            ChannelFuture future = bootstrap.bind(8080).sync();
            System.out.println("Netty服务器启动");
            
            future.channel().closeFuture().sync();
        } finally {
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
}

class ServerHandler extends ChannelInboundHandlerAdapter {
    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {
        String message = (String) msg;
        System.out.println("收到：" + message);
        ctx.writeAndFlush("服务器回复：" + message);
    }
    
    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {
        cause.printStackTrace();
        ctx.close();
    }
}
```

## 6. WebSocket ⭐⭐⭐⭐

### Spring Boot WebSocket ⭐⭐⭐⭐⭐

```java
import org.springframework.context.annotation.Configuration;
import org.springframework.web.socket.*;
import org.springframework.web.socket.config.annotation.*;

@Configuration
@EnableWebSocket
public class WebSocketConfig implements WebSocketConfigurer {
    
    @Override
    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        registry.addHandler(new MyWebSocketHandler(), "/ws")
            .setAllowedOrigins("*");
    }
}

class MyWebSocketHandler extends TextWebSocketHandler {
    
    @Override
    public void afterConnectionEstablished(WebSocketSession session) {
        System.out.println("WebSocket连接建立");
    }
    
    @Override
    protected void handleTextMessage(WebSocketSession session, TextMessage message) 
            throws Exception {
        String payload = message.getPayload();
        System.out.println("收到消息：" + payload);
        
        session.sendMessage(new TextMessage("服务器回复：" + payload));
    }
    
    @Override
    public void afterConnectionClosed(WebSocketSession session, CloseStatus status) {
        System.out.println("WebSocket连接关闭");
    }
}
```

## 💡 最佳实践 ⭐⭐⭐⭐⭐

### 1. 连接池

```java
// 使用连接池提高性能
HttpClient client = HttpClient.newBuilder()
    .connectTimeout(Duration.ofSeconds(10))
    .build();
```

### 2. 超时设置

```java
HttpRequest request = HttpRequest.newBuilder()
    .uri(URI.create("https://example.com"))
    .timeout(Duration.ofSeconds(5))  // 超时设置
    .build();
```

### 3. 异常处理

```java
try {
    // 网络操作
} catch (IOException e) {
    // 处理IO异常
} catch (InterruptedException e) {
    Thread.currentThread().interrupt();
}
```

## 🎯 实战练习

1. 实现一个简单的聊天室
2. 使用HttpClient调用REST API
3. 实现文件上传下载
4. 使用Netty实现RPC框架

## 📚 下一步

学习完网络编程后，继续学习：
- [多线程并发](./多线程并发.md)
- [Spring Cloud](../04-Spring生态/SpringCloud.md)

