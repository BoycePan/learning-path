# Java单元测试

## 📌 学习目标

- 理解单元测试的重要性
- 掌握JUnit 5使用
- 熟练使用Mockito
- 了解测试覆盖率
- 掌握Spring Boot测试

## ⭐ 核心内容

- **JUnit 5** ⭐⭐⭐⭐⭐
- **Mockito** ⭐⭐⭐⭐⭐
- **断言** ⭐⭐⭐⭐⭐
- **Spring Boot Test** ⭐⭐⭐⭐⭐
- **测试覆盖率** ⭐⭐⭐⭐

## 1. 为什么需要单元测试 ⭐⭐⭐⭐⭐

### 单元测试的好处

```java
// 1. 及早发现bug
// 2. 重构时保证功能不变
// 3. 文档作用 - 展示如何使用代码
// 4. 提高代码质量
// 5. 降低维护成本
```

### 测试金字塔

```
        /\
       /  \  E2E测试（少量）
      /____\
     /      \  集成测试（适量）
    /________\
   /          \  单元测试（大量）⭐⭐⭐⭐⭐
  /__________  \
```

## 2. JUnit 5基础 ⭐⭐⭐⭐⭐

### Maven依赖

```xml
<dependencies>
    <!-- JUnit 5 ⭐⭐⭐⭐⭐ -->
    <dependency>
        <groupId>org.junit.jupiter</groupId>
        <artifactId>junit-jupiter</artifactId>
        <version>5.10.1</version>
        <scope>test</scope>
    </dependency>
    
    <!-- Mockito ⭐⭐⭐⭐⭐ -->
    <dependency>
        <groupId>org.mockito</groupId>
        <artifactId>mockito-core</artifactId>
        <version>5.7.0</version>
        <scope>test</scope>
    </dependency>
    
    <!-- AssertJ（可选，更好的断言）⭐⭐⭐⭐ -->
    <dependency>
        <groupId>org.assertj</groupId>
        <artifactId>assertj-core</artifactId>
        <version>3.24.2</version>
        <scope>test</scope>
    </dependency>
</dependencies>
```

### 基础测试 ⭐⭐⭐⭐⭐

```java
import org.junit.jupiter.api.*;
import static org.junit.jupiter.api.Assertions.*;

// 被测试类
public class Calculator {
    public int add(int a, int b) {
        return a + b;
    }
    
    public int divide(int a, int b) {
        if (b == 0) {
            throw new IllegalArgumentException("除数不能为0");
        }
        return a / b;
    }
}

// 测试类 ⭐⭐⭐⭐⭐
class CalculatorTest {
    
    private Calculator calculator;
    
    // 每个测试方法执行前运行 ⭐⭐⭐⭐⭐
    @BeforeEach
    void setUp() {
        calculator = new Calculator();
        System.out.println("初始化");
    }
    
    // 每个测试方法执行后运行
    @AfterEach
    void tearDown() {
        System.out.println("清理");
    }
    
    // 所有测试方法执行前运行一次
    @BeforeAll
    static void setUpAll() {
        System.out.println("开始测试");
    }
    
    // 所有测试方法执行后运行一次
    @AfterAll
    static void tearDownAll() {
        System.out.println("测试结束");
    }
    
    // 测试方法 ⭐⭐⭐⭐⭐
    @Test
    @DisplayName("测试加法")
    void testAdd() {
        int result = calculator.add(2, 3);
        assertEquals(5, result, "2 + 3 应该等于 5");
    }
    
    @Test
    @DisplayName("测试除法")
    void testDivide() {
        int result = calculator.divide(10, 2);
        assertEquals(5, result);
    }
    
    @Test
    @DisplayName("测试除以0抛出异常")
    void testDivideByZero() {
        assertThrows(IllegalArgumentException.class, () -> {
            calculator.divide(10, 0);
        });
    }
    
    // 禁用测试
    @Test
    @Disabled("暂时禁用")
    void testDisabled() {
        // 不会执行
    }
    
    // 超时测试
    @Test
    @Timeout(1)  // 1秒超时
    void testTimeout() {
        // 测试代码
    }
}
```

### 常用断言 ⭐⭐⭐⭐⭐

```java
import static org.junit.jupiter.api.Assertions.*;

class AssertionsTest {
    
    @Test
    void testAssertions() {
        // 相等断言 ⭐⭐⭐⭐⭐
        assertEquals(5, 2 + 3);
        assertEquals("Hello", "Hello");
        assertNotEquals(5, 3);
        
        // 布尔断言 ⭐⭐⭐⭐⭐
        assertTrue(5 > 3);
        assertFalse(5 < 3);
        
        // null断言 ⭐⭐⭐⭐⭐
        assertNull(null);
        assertNotNull("Hello");
        
        // 数组断言
        int[] expected = {1, 2, 3};
        int[] actual = {1, 2, 3};
        assertArrayEquals(expected, actual);
        
        // 异常断言 ⭐⭐⭐⭐⭐
        Exception exception = assertThrows(
            IllegalArgumentException.class,
            () -> { throw new IllegalArgumentException("错误"); }
        );
        assertEquals("错误", exception.getMessage());
        
        // 组合断言
        assertAll("用户信息",
            () -> assertEquals("Alice", user.getName()),
            () -> assertEquals(25, user.getAge()),
            () -> assertNotNull(user.getEmail())
        );
    }
}
```

### 参数化测试 ⭐⭐⭐⭐⭐

```java
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.*;

class ParameterizedTests {
    
    // 值源 ⭐⭐⭐⭐⭐
    @ParameterizedTest
    @ValueSource(ints = {1, 2, 3, 4, 5})
    void testWithValueSource(int number) {
        assertTrue(number > 0);
    }
    
    // CSV源 ⭐⭐⭐⭐⭐
    @ParameterizedTest
    @CsvSource({
        "1, 2, 3",
        "2, 3, 5",
        "3, 4, 7"
    })
    void testAdd(int a, int b, int expected) {
        assertEquals(expected, calculator.add(a, b));
    }
    
    // 方法源 ⭐⭐⭐⭐
    @ParameterizedTest
    @MethodSource("provideStrings")
    void testWithMethodSource(String str) {
        assertNotNull(str);
    }
    
    static Stream<String> provideStrings() {
        return Stream.of("apple", "banana", "orange");
    }
}
```

## 3. Mockito使用 ⭐⭐⭐⭐⭐

### 为什么需要Mock？

```java
// 问题：测试UserService时，不想真正访问数据库
public class UserService {
    private UserRepository repository;  // 依赖
    
    public User findById(Long id) {
        return repository.findById(id);  // 调用数据库
    }
}

// 解决：使用Mock对象模拟repository
```

### Mock基础 ⭐⭐⭐⭐⭐

```java
import org.mockito.*;
import static org.mockito.Mockito.*;

class UserServiceTest {
    
    @Mock
    private UserRepository repository;  // Mock对象
    
    @InjectMocks
    private UserService service;  // 自动注入Mock
    
    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);  // 初始化Mock
    }
    
    @Test
    void testFindById() {
        // 准备测试数据
        User user = new User(1L, "Alice", 25);
        
        // 设置Mock行为 ⭐⭐⭐⭐⭐
        when(repository.findById(1L)).thenReturn(user);
        
        // 执行测试
        User result = service.findById(1L);
        
        // 验证结果
        assertEquals("Alice", result.getName());
        
        // 验证方法被调用 ⭐⭐⭐⭐⭐
        verify(repository).findById(1L);
        verify(repository, times(1)).findById(1L);
    }
    
    @Test
    void testSave() {
        User user = new User(null, "Bob", 30);
        User savedUser = new User(1L, "Bob", 30);
        
        // Mock返回值
        when(repository.save(any(User.class))).thenReturn(savedUser);
        
        User result = service.save(user);
        
        assertNotNull(result.getId());
        verify(repository).save(user);
    }
    
    @Test
    void testDelete() {
        // Mock void方法
        doNothing().when(repository).deleteById(1L);
        
        service.delete(1L);
        
        verify(repository).deleteById(1L);
    }
    
    @Test
    void testFindByIdThrowsException() {
        // Mock抛出异常 ⭐⭐⭐⭐⭐
        when(repository.findById(999L))
            .thenThrow(new RuntimeException("用户不存在"));
        
        assertThrows(RuntimeException.class, () -> {
            service.findById(999L);
        });
    }
}
```

### Mock高级用法 ⭐⭐⭐⭐

```java
class AdvancedMockTest {
    
    @Test
    void testArgumentCaptor() {
        // 参数捕获器 ⭐⭐⭐⭐
        ArgumentCaptor<User> captor = ArgumentCaptor.forClass(User.class);
        
        service.save(new User(null, "Charlie", 28));
        
        verify(repository).save(captor.capture());
        User captured = captor.getValue();
        assertEquals("Charlie", captured.getName());
    }
    
    @Test
    void testAnswer() {
        // 自定义返回逻辑 ⭐⭐⭐⭐
        when(repository.findById(anyLong())).thenAnswer(invocation -> {
            Long id = invocation.getArgument(0);
            return new User(id, "User" + id, 25);
        });
        
        User user = service.findById(5L);
        assertEquals("User5", user.getName());
    }
    
    @Test
    void testSpy() {
        // Spy：部分Mock ⭐⭐⭐⭐
        UserService spy = spy(new UserService(repository));
        
        doReturn(new User(1L, "Spy", 30))
            .when(spy).findById(1L);
        
        User user = spy.findById(1L);
        assertEquals("Spy", user.getName());
    }
}
```

## 4. Spring Boot测试 ⭐⭐⭐⭐⭐

### 依赖配置

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
    <scope>test</scope>
</dependency>
```

### Controller测试 ⭐⭐⭐⭐⭐

```java
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.test.web.servlet.MockMvc;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@WebMvcTest(UserController.class)
class UserControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private UserService userService;
    
    @Test
    void testGetUser() throws Exception {
        User user = new User(1L, "Alice", 25);
        when(userService.findById(1L)).thenReturn(user);
        
        mockMvc.perform(get("/users/1"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.name").value("Alice"))
            .andExpect(jsonPath("$.age").value(25));
    }
    
    @Test
    void testCreateUser() throws Exception {
        String json = "{\"name\":\"Bob\",\"age\":30}";
        
        mockMvc.perform(post("/users")
                .contentType(MediaType.APPLICATION_JSON)
                .content(json))
            .andExpect(status().isCreated());
    }
}
```

### Service测试 ⭐⭐⭐⭐⭐

```java
@SpringBootTest
class UserServiceIntegrationTest {
    
    @Autowired
    private UserService userService;
    
    @MockBean
    private UserRepository repository;
    
    @Test
    void testFindById() {
        User user = new User(1L, "Alice", 25);
        when(repository.findById(1L)).thenReturn(Optional.of(user));
        
        User result = userService.findById(1L);
        
        assertNotNull(result);
        assertEquals("Alice", result.getName());
    }
}
```

### Repository测试 ⭐⭐⭐⭐⭐

```java
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;

@DataJpaTest
class UserRepositoryTest {
    
    @Autowired
    private UserRepository repository;
    
    @Autowired
    private TestEntityManager entityManager;
    
    @Test
    void testFindByName() {
        // 准备数据
        User user = new User(null, "Alice", 25);
        entityManager.persist(user);
        entityManager.flush();
        
        // 执行查询
        User found = repository.findByName("Alice");
        
        // 验证结果
        assertNotNull(found);
        assertEquals("Alice", found.getName());
    }
}
```

## 5. 测试最佳实践 ⭐⭐⭐⭐⭐

### 测试命名规范

```java
// 方法命名：test + 方法名 + 场景 + 预期结果
@Test
void testFindById_WhenUserExists_ReturnsUser() { }

@Test
void testFindById_WhenUserNotExists_ThrowsException() { }

@Test
void testSave_WhenValidUser_SavesSuccessfully() { }
```

### AAA模式 ⭐⭐⭐⭐⭐

```java
@Test
void testExample() {
    // Arrange（准备）- 准备测试数据和环境
    User user = new User(1L, "Alice", 25);
    when(repository.findById(1L)).thenReturn(user);
    
    // Act（执行）- 执行被测试的方法
    User result = service.findById(1L);
    
    // Assert（断言）- 验证结果
    assertEquals("Alice", result.getName());
    verify(repository).findById(1L);
}
```

### 测试覆盖率 ⭐⭐⭐⭐

```xml
<!-- JaCoCo插件 -->
<plugin>
    <groupId>org.jacoco</groupId>
    <artifactId>jacoco-maven-plugin</artifactId>
    <version>0.8.11</version>
    <executions>
        <execution>
            <goals>
                <goal>prepare-agent</goal>
            </goals>
        </execution>
        <execution>
            <id>report</id>
            <phase>test</phase>
            <goals>
                <goal>report</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

```bash
# 运行测试并生成覆盖率报告
mvn clean test
# 查看报告：target/site/jacoco/index.html

# 目标覆盖率：
# 行覆盖率：> 80%
# 分支覆盖率：> 70%
```

## 💡 测试技巧 ⭐⭐⭐⭐⭐

### 1. 测试边界条件

```java
@Test
void testBoundaryConditions() {
    // 测试空值
    assertThrows(NullPointerException.class, () -> service.save(null));
    
    // 测试空列表
    List<User> empty = service.findAll();
    assertTrue(empty.isEmpty());
    
    // 测试边界值
    assertEquals(0, calculator.divide(0, 1));
}
```

### 2. 使用测试数据构建器

```java
class UserTestBuilder {
    private Long id = 1L;
    private String name = "Test";
    private int age = 25;
    
    public UserTestBuilder withId(Long id) {
        this.id = id;
        return this;
    }
    
    public UserTestBuilder withName(String name) {
        this.name = name;
        return this;
    }
    
    public User build() {
        return new User(id, name, age);
    }
}

// 使用
User user = new UserTestBuilder()
    .withName("Alice")
    .withAge(30)
    .build();
```

## 🎯 实战练习

1. 为Calculator类编写完整测试
2. 使用Mockito测试UserService
3. 编写Spring Boot Controller测试
4. 达到80%以上的测试覆盖率

## 📚 下一步

学习完单元测试后，继续学习：
- [网络编程](./网络编程.md)
- [Spring核心](../04-Spring生态/Spring核心.md)

