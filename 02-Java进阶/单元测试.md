# Javaå•å…ƒæµ‹è¯•

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç†è§£å•å…ƒæµ‹è¯•çš„é‡è¦æ€§
- æŒæ¡JUnit 5ä½¿ç”¨
- ç†Ÿç»ƒä½¿ç”¨Mockito
- äº†è§£æµ‹è¯•è¦†ç›–ç‡
- æŒæ¡Spring Bootæµ‹è¯•

## â­ æ ¸å¿ƒå†…å®¹

- **JUnit 5** â­â­â­â­â­
- **Mockito** â­â­â­â­â­
- **æ–­è¨€** â­â­â­â­â­
- **Spring Boot Test** â­â­â­â­â­
- **æµ‹è¯•è¦†ç›–ç‡** â­â­â­â­

## 1. ä¸ºä»€ä¹ˆéœ€è¦å•å…ƒæµ‹è¯• â­â­â­â­â­

### å•å…ƒæµ‹è¯•çš„å¥½å¤„

```java
// 1. åŠæ—©å‘ç°bug
// 2. é‡æ„æ—¶ä¿è¯åŠŸèƒ½ä¸å˜
// 3. æ–‡æ¡£ä½œç”¨ - å±•ç¤ºå¦‚ä½•ä½¿ç”¨ä»£ç 
// 4. æé«˜ä»£ç è´¨é‡
// 5. é™ä½ç»´æŠ¤æˆæœ¬
```

### æµ‹è¯•é‡‘å­—å¡”

```
        /\
       /  \  E2Eæµ‹è¯•ï¼ˆå°‘é‡ï¼‰
      /____\
     /      \  é›†æˆæµ‹è¯•ï¼ˆé€‚é‡ï¼‰
    /________\
   /          \  å•å…ƒæµ‹è¯•ï¼ˆå¤§é‡ï¼‰â­â­â­â­â­
  /__________  \
```

## 2. JUnit 5åŸºç¡€ â­â­â­â­â­

### Mavenä¾èµ–

```xml
<dependencies>
    <!-- JUnit 5 â­â­â­â­â­ -->
    <dependency>
        <groupId>org.junit.jupiter</groupId>
        <artifactId>junit-jupiter</artifactId>
        <version>5.10.1</version>
        <scope>test</scope>
    </dependency>
    
    <!-- Mockito â­â­â­â­â­ -->
    <dependency>
        <groupId>org.mockito</groupId>
        <artifactId>mockito-core</artifactId>
        <version>5.7.0</version>
        <scope>test</scope>
    </dependency>
    
    <!-- AssertJï¼ˆå¯é€‰ï¼Œæ›´å¥½çš„æ–­è¨€ï¼‰â­â­â­â­ -->
    <dependency>
        <groupId>org.assertj</groupId>
        <artifactId>assertj-core</artifactId>
        <version>3.24.2</version>
        <scope>test</scope>
    </dependency>
</dependencies>
```

### åŸºç¡€æµ‹è¯• â­â­â­â­â­

```java
import org.junit.jupiter.api.*;
import static org.junit.jupiter.api.Assertions.*;

// è¢«æµ‹è¯•ç±»
public class Calculator {
    public int add(int a, int b) {
        return a + b;
    }
    
    public int divide(int a, int b) {
        if (b == 0) {
            throw new IllegalArgumentException("é™¤æ•°ä¸èƒ½ä¸º0");
        }
        return a / b;
    }
}

// æµ‹è¯•ç±» â­â­â­â­â­
class CalculatorTest {
    
    private Calculator calculator;
    
    // æ¯ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œå‰è¿è¡Œ â­â­â­â­â­
    @BeforeEach
    void setUp() {
        calculator = new Calculator();
        System.out.println("åˆå§‹åŒ–");
    }
    
    // æ¯ä¸ªæµ‹è¯•æ–¹æ³•æ‰§è¡Œåè¿è¡Œ
    @AfterEach
    void tearDown() {
        System.out.println("æ¸…ç†");
    }
    
    // æ‰€æœ‰æµ‹è¯•æ–¹æ³•æ‰§è¡Œå‰è¿è¡Œä¸€æ¬¡
    @BeforeAll
    static void setUpAll() {
        System.out.println("å¼€å§‹æµ‹è¯•");
    }
    
    // æ‰€æœ‰æµ‹è¯•æ–¹æ³•æ‰§è¡Œåè¿è¡Œä¸€æ¬¡
    @AfterAll
    static void tearDownAll() {
        System.out.println("æµ‹è¯•ç»“æŸ");
    }
    
    // æµ‹è¯•æ–¹æ³• â­â­â­â­â­
    @Test
    @DisplayName("æµ‹è¯•åŠ æ³•")
    void testAdd() {
        int result = calculator.add(2, 3);
        assertEquals(5, result, "2 + 3 åº”è¯¥ç­‰äº 5");
    }
    
    @Test
    @DisplayName("æµ‹è¯•é™¤æ³•")
    void testDivide() {
        int result = calculator.divide(10, 2);
        assertEquals(5, result);
    }
    
    @Test
    @DisplayName("æµ‹è¯•é™¤ä»¥0æŠ›å‡ºå¼‚å¸¸")
    void testDivideByZero() {
        assertThrows(IllegalArgumentException.class, () -> {
            calculator.divide(10, 0);
        });
    }
    
    // ç¦ç”¨æµ‹è¯•
    @Test
    @Disabled("æš‚æ—¶ç¦ç”¨")
    void testDisabled() {
        // ä¸ä¼šæ‰§è¡Œ
    }
    
    // è¶…æ—¶æµ‹è¯•
    @Test
    @Timeout(1)  // 1ç§’è¶…æ—¶
    void testTimeout() {
        // æµ‹è¯•ä»£ç 
    }
}
```

### å¸¸ç”¨æ–­è¨€ â­â­â­â­â­

```java
import static org.junit.jupiter.api.Assertions.*;

class AssertionsTest {
    
    @Test
    void testAssertions() {
        // ç›¸ç­‰æ–­è¨€ â­â­â­â­â­
        assertEquals(5, 2 + 3);
        assertEquals("Hello", "Hello");
        assertNotEquals(5, 3);
        
        // å¸ƒå°”æ–­è¨€ â­â­â­â­â­
        assertTrue(5 > 3);
        assertFalse(5 < 3);
        
        // nullæ–­è¨€ â­â­â­â­â­
        assertNull(null);
        assertNotNull("Hello");
        
        // æ•°ç»„æ–­è¨€
        int[] expected = {1, 2, 3};
        int[] actual = {1, 2, 3};
        assertArrayEquals(expected, actual);
        
        // å¼‚å¸¸æ–­è¨€ â­â­â­â­â­
        Exception exception = assertThrows(
            IllegalArgumentException.class,
            () -> { throw new IllegalArgumentException("é”™è¯¯"); }
        );
        assertEquals("é”™è¯¯", exception.getMessage());
        
        // ç»„åˆæ–­è¨€
        assertAll("ç”¨æˆ·ä¿¡æ¯",
            () -> assertEquals("Alice", user.getName()),
            () -> assertEquals(25, user.getAge()),
            () -> assertNotNull(user.getEmail())
        );
    }
}
```

### å‚æ•°åŒ–æµ‹è¯• â­â­â­â­â­

```java
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.*;

class ParameterizedTests {
    
    // å€¼æº â­â­â­â­â­
    @ParameterizedTest
    @ValueSource(ints = {1, 2, 3, 4, 5})
    void testWithValueSource(int number) {
        assertTrue(number > 0);
    }
    
    // CSVæº â­â­â­â­â­
    @ParameterizedTest
    @CsvSource({
        "1, 2, 3",
        "2, 3, 5",
        "3, 4, 7"
    })
    void testAdd(int a, int b, int expected) {
        assertEquals(expected, calculator.add(a, b));
    }
    
    // æ–¹æ³•æº â­â­â­â­
    @ParameterizedTest
    @MethodSource("provideStrings")
    void testWithMethodSource(String str) {
        assertNotNull(str);
    }
    
    static Stream<String> provideStrings() {
        return Stream.of("apple", "banana", "orange");
    }
}
```

## 3. Mockitoä½¿ç”¨ â­â­â­â­â­

### ä¸ºä»€ä¹ˆéœ€è¦Mockï¼Ÿ

```java
// é—®é¢˜ï¼šæµ‹è¯•UserServiceæ—¶ï¼Œä¸æƒ³çœŸæ­£è®¿é—®æ•°æ®åº“
public class UserService {
    private UserRepository repository;  // ä¾èµ–
    
    public User findById(Long id) {
        return repository.findById(id);  // è°ƒç”¨æ•°æ®åº“
    }
}

// è§£å†³ï¼šä½¿ç”¨Mockå¯¹è±¡æ¨¡æ‹Ÿrepository
```

### MockåŸºç¡€ â­â­â­â­â­

```java
import org.mockito.*;
import static org.mockito.Mockito.*;

class UserServiceTest {
    
    @Mock
    private UserRepository repository;  // Mockå¯¹è±¡
    
    @InjectMocks
    private UserService service;  // è‡ªåŠ¨æ³¨å…¥Mock
    
    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);  // åˆå§‹åŒ–Mock
    }
    
    @Test
    void testFindById() {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        User user = new User(1L, "Alice", 25);
        
        // è®¾ç½®Mockè¡Œä¸º â­â­â­â­â­
        when(repository.findById(1L)).thenReturn(user);
        
        // æ‰§è¡Œæµ‹è¯•
        User result = service.findById(1L);
        
        // éªŒè¯ç»“æœ
        assertEquals("Alice", result.getName());
        
        // éªŒè¯æ–¹æ³•è¢«è°ƒç”¨ â­â­â­â­â­
        verify(repository).findById(1L);
        verify(repository, times(1)).findById(1L);
    }
    
    @Test
    void testSave() {
        User user = new User(null, "Bob", 30);
        User savedUser = new User(1L, "Bob", 30);
        
        // Mockè¿”å›å€¼
        when(repository.save(any(User.class))).thenReturn(savedUser);
        
        User result = service.save(user);
        
        assertNotNull(result.getId());
        verify(repository).save(user);
    }
    
    @Test
    void testDelete() {
        // Mock voidæ–¹æ³•
        doNothing().when(repository).deleteById(1L);
        
        service.delete(1L);
        
        verify(repository).deleteById(1L);
    }
    
    @Test
    void testFindByIdThrowsException() {
        // MockæŠ›å‡ºå¼‚å¸¸ â­â­â­â­â­
        when(repository.findById(999L))
            .thenThrow(new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨"));
        
        assertThrows(RuntimeException.class, () -> {
            service.findById(999L);
        });
    }
}
```

### Mocké«˜çº§ç”¨æ³• â­â­â­â­

```java
class AdvancedMockTest {
    
    @Test
    void testArgumentCaptor() {
        // å‚æ•°æ•è·å™¨ â­â­â­â­
        ArgumentCaptor<User> captor = ArgumentCaptor.forClass(User.class);
        
        service.save(new User(null, "Charlie", 28));
        
        verify(repository).save(captor.capture());
        User captured = captor.getValue();
        assertEquals("Charlie", captured.getName());
    }
    
    @Test
    void testAnswer() {
        // è‡ªå®šä¹‰è¿”å›é€»è¾‘ â­â­â­â­
        when(repository.findById(anyLong())).thenAnswer(invocation -> {
            Long id = invocation.getArgument(0);
            return new User(id, "User" + id, 25);
        });
        
        User user = service.findById(5L);
        assertEquals("User5", user.getName());
    }
    
    @Test
    void testSpy() {
        // Spyï¼šéƒ¨åˆ†Mock â­â­â­â­
        UserService spy = spy(new UserService(repository));
        
        doReturn(new User(1L, "Spy", 30))
            .when(spy).findById(1L);
        
        User user = spy.findById(1L);
        assertEquals("Spy", user.getName());
    }
}
```

## 4. Spring Bootæµ‹è¯• â­â­â­â­â­

### ä¾èµ–é…ç½®

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
    <scope>test</scope>
</dependency>
```

### Controlleræµ‹è¯• â­â­â­â­â­

```java
import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;
import org.springframework.test.web.servlet.MockMvc;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.*;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@WebMvcTest(UserController.class)
class UserControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private UserService userService;
    
    @Test
    void testGetUser() throws Exception {
        User user = new User(1L, "Alice", 25);
        when(userService.findById(1L)).thenReturn(user);
        
        mockMvc.perform(get("/users/1"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.name").value("Alice"))
            .andExpect(jsonPath("$.age").value(25));
    }
    
    @Test
    void testCreateUser() throws Exception {
        String json = "{\"name\":\"Bob\",\"age\":30}";
        
        mockMvc.perform(post("/users")
                .contentType(MediaType.APPLICATION_JSON)
                .content(json))
            .andExpect(status().isCreated());
    }
}
```

### Serviceæµ‹è¯• â­â­â­â­â­

```java
@SpringBootTest
class UserServiceIntegrationTest {
    
    @Autowired
    private UserService userService;
    
    @MockBean
    private UserRepository repository;
    
    @Test
    void testFindById() {
        User user = new User(1L, "Alice", 25);
        when(repository.findById(1L)).thenReturn(Optional.of(user));
        
        User result = userService.findById(1L);
        
        assertNotNull(result);
        assertEquals("Alice", result.getName());
    }
}
```

### Repositoryæµ‹è¯• â­â­â­â­â­

```java
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;

@DataJpaTest
class UserRepositoryTest {
    
    @Autowired
    private UserRepository repository;
    
    @Autowired
    private TestEntityManager entityManager;
    
    @Test
    void testFindByName() {
        // å‡†å¤‡æ•°æ®
        User user = new User(null, "Alice", 25);
        entityManager.persist(user);
        entityManager.flush();
        
        // æ‰§è¡ŒæŸ¥è¯¢
        User found = repository.findByName("Alice");
        
        // éªŒè¯ç»“æœ
        assertNotNull(found);
        assertEquals("Alice", found.getName());
    }
}
```

## 5. æµ‹è¯•æœ€ä½³å®è·µ â­â­â­â­â­

### æµ‹è¯•å‘½åè§„èŒƒ

```java
// æ–¹æ³•å‘½åï¼štest + æ–¹æ³•å + åœºæ™¯ + é¢„æœŸç»“æœ
@Test
void testFindById_WhenUserExists_ReturnsUser() { }

@Test
void testFindById_WhenUserNotExists_ThrowsException() { }

@Test
void testSave_WhenValidUser_SavesSuccessfully() { }
```

### AAAæ¨¡å¼ â­â­â­â­â­

```java
@Test
void testExample() {
    // Arrangeï¼ˆå‡†å¤‡ï¼‰- å‡†å¤‡æµ‹è¯•æ•°æ®å’Œç¯å¢ƒ
    User user = new User(1L, "Alice", 25);
    when(repository.findById(1L)).thenReturn(user);
    
    // Actï¼ˆæ‰§è¡Œï¼‰- æ‰§è¡Œè¢«æµ‹è¯•çš„æ–¹æ³•
    User result = service.findById(1L);
    
    // Assertï¼ˆæ–­è¨€ï¼‰- éªŒè¯ç»“æœ
    assertEquals("Alice", result.getName());
    verify(repository).findById(1L);
}
```

### æµ‹è¯•è¦†ç›–ç‡ â­â­â­â­

```xml
<!-- JaCoCoæ’ä»¶ -->
<plugin>
    <groupId>org.jacoco</groupId>
    <artifactId>jacoco-maven-plugin</artifactId>
    <version>0.8.11</version>
    <executions>
        <execution>
            <goals>
                <goal>prepare-agent</goal>
            </goals>
        </execution>
        <execution>
            <id>report</id>
            <phase>test</phase>
            <goals>
                <goal>report</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

```bash
# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
mvn clean test
# æŸ¥çœ‹æŠ¥å‘Šï¼štarget/site/jacoco/index.html

# ç›®æ ‡è¦†ç›–ç‡ï¼š
# è¡Œè¦†ç›–ç‡ï¼š> 80%
# åˆ†æ”¯è¦†ç›–ç‡ï¼š> 70%
```

## ğŸ’¡ æµ‹è¯•æŠ€å·§ â­â­â­â­â­

### 1. æµ‹è¯•è¾¹ç•Œæ¡ä»¶

```java
@Test
void testBoundaryConditions() {
    // æµ‹è¯•ç©ºå€¼
    assertThrows(NullPointerException.class, () -> service.save(null));
    
    // æµ‹è¯•ç©ºåˆ—è¡¨
    List<User> empty = service.findAll();
    assertTrue(empty.isEmpty());
    
    // æµ‹è¯•è¾¹ç•Œå€¼
    assertEquals(0, calculator.divide(0, 1));
}
```

### 2. ä½¿ç”¨æµ‹è¯•æ•°æ®æ„å»ºå™¨

```java
class UserTestBuilder {
    private Long id = 1L;
    private String name = "Test";
    private int age = 25;
    
    public UserTestBuilder withId(Long id) {
        this.id = id;
        return this;
    }
    
    public UserTestBuilder withName(String name) {
        this.name = name;
        return this;
    }
    
    public User build() {
        return new User(id, name, age);
    }
}

// ä½¿ç”¨
User user = new UserTestBuilder()
    .withName("Alice")
    .withAge(30)
    .build();
```

## ğŸ¯ å®æˆ˜ç»ƒä¹ 

1. ä¸ºCalculatorç±»ç¼–å†™å®Œæ•´æµ‹è¯•
2. ä½¿ç”¨Mockitoæµ‹è¯•UserService
3. ç¼–å†™Spring Boot Controlleræµ‹è¯•
4. è¾¾åˆ°80%ä»¥ä¸Šçš„æµ‹è¯•è¦†ç›–ç‡

## ğŸ“š ä¸‹ä¸€æ­¥

å­¦ä¹ å®Œå•å…ƒæµ‹è¯•åï¼Œç»§ç»­å­¦ä¹ ï¼š
- [ç½‘ç»œç¼–ç¨‹](./ç½‘ç»œç¼–ç¨‹.md)
- [Springæ ¸å¿ƒ](../04-Springç”Ÿæ€/Springæ ¸å¿ƒ.md)

