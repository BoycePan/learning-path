# Java异常处理

## 📌 学习目标

- 理解异常的概念和分类
- 掌握异常处理机制
- 学会自定义异常
- 掌握异常处理最佳实践

## ⭐ 异常体系结构

```
Throwable
├── Error (错误,无法处理)
│   ├── OutOfMemoryError
│   ├── StackOverflowError
│   └── ...
│
└── Exception (异常,可以处理) ⭐⭐⭐⭐⭐
    ├── RuntimeException (运行时异常,非受检) ⭐⭐⭐⭐⭐
    │   ├── NullPointerException (空指针)
    │   ├── ArrayIndexOutOfBoundsException (数组越界)
    │   ├── ArithmeticException (算术异常)
    │   ├── ClassCastException (类型转换异常)
    │   ├── IllegalArgumentException (非法参数)
    │   └── NumberFormatException (数字格式异常)
    │
    └── 其他异常 (编译时异常,受检异常) ⭐⭐⭐⭐⭐
        ├── IOException (IO异常)
        ├── SQLException (数据库异常)
        ├── ClassNotFoundException
        └── ...
```

## 1. 异常基础 ⭐⭐⭐⭐⭐

### 常见异常示例

```java
public class CommonExceptions {
    public static void main(String[] args) {
        // 1. NullPointerException - 空指针异常 ⭐⭐⭐⭐⭐
        String str = null;
        try {
            System.out.println(str.length());  // 会抛出空指针异常
        } catch (NullPointerException e) {
            System.out.println("空指针异常：" + e.getMessage());
        }
        
        // 2. ArrayIndexOutOfBoundsException - 数组越界 ⭐⭐⭐⭐⭐
        int[] arr = {1, 2, 3};
        try {
            System.out.println(arr[5]);
        } catch (ArrayIndexOutOfBoundsException e) {
            System.out.println("数组越界：" + e.getMessage());
        }
        
        // 3. ArithmeticException - 算术异常 ⭐⭐⭐⭐
        try {
            int result = 10 / 0;  // 除以0
        } catch (ArithmeticException e) {
            System.out.println("算术异常：" + e.getMessage());
        }
        
        // 4. NumberFormatException - 数字格式异常 ⭐⭐⭐⭐
        try {
            int num = Integer.parseInt("abc");
        } catch (NumberFormatException e) {
            System.out.println("数字格式异常：" + e.getMessage());
        }
        
        // 5. ClassCastException - 类型转换异常 ⭐⭐⭐⭐
        try {
            Object obj = "字符串";
            Integer num = (Integer) obj;
        } catch (ClassCastException e) {
            System.out.println("类型转换异常：" + e.getMessage());
        }
    }
}
```

## 2. try-catch-finally ⭐⭐⭐⭐⭐

### 基本用法

```java
public class TryCatchDemo {
    public static void main(String[] args) {
        // 基本try-catch ⭐⭐⭐⭐⭐
        try {
            int result = divide(10, 0);
            System.out.println("结果：" + result);
        } catch (ArithmeticException e) {
            System.out.println("捕获异常：" + e.getMessage());
            e.printStackTrace();  // 打印异常堆栈
        }
        
        System.out.println("程序继续运行");
    }
    
    public static int divide(int a, int b) {
        return a / b;
    }
}
```

### 多重catch ⭐⭐⭐⭐⭐

```java
public class MultipleCatch {
    public static void main(String[] args) {
        // 多个catch块 ⭐⭐⭐⭐⭐
        try {
            String str = null;
            System.out.println(str.length());
            
            int[] arr = {1, 2, 3};
            System.out.println(arr[10]);
            
            int result = 10 / 0;
        } catch (NullPointerException e) {
            System.out.println("空指针异常");
        } catch (ArrayIndexOutOfBoundsException e) {
            System.out.println("数组越界异常");
        } catch (ArithmeticException e) {
            System.out.println("算术异常");
        } catch (Exception e) {  // 通用异常放最后 ⭐⭐⭐⭐⭐
            System.out.println("其他异常：" + e);
        }
        
        // Java 7+ 多异常捕获（推荐） ⭐⭐⭐⭐⭐
        try {
            // 代码...
            int num = Integer.parseInt("abc");
        } catch (NumberFormatException | NullPointerException e) {
            System.out.println("数字格式异常或空指针异常");
            e.printStackTrace();
        }
    }
}
```

### finally块 ⭐⭐⭐⭐⭐

```java
import java.io.*;

public class FinallyDemo {
    public static void main(String[] args) {
        // finally总是执行 ⭐⭐⭐⭐⭐
        FileReader reader = null;
        try {
            reader = new FileReader("test.txt");
            int data = reader.read();
            System.out.println((char) data);
        } catch (FileNotFoundException e) {
            System.out.println("文件未找到");
        } catch (IOException e) {
            System.out.println("读取错误");
        } finally {
            // 无论是否发生异常，都会执行 ⭐⭐⭐⭐⭐
            System.out.println("finally块执行");
            if (reader != null) {
                try {
                    reader.close();  // 关闭资源
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
    }
    
    // finally vs return ⭐⭐⭐⭐
    public static int testFinally() {
        try {
            return 1;
        } finally {
            System.out.println("finally执行");  // 在return之前执行
            // return 2;  // 不推荐在finally中return
        }
    }
}
```

## 3. try-with-resources ⭐⭐⭐⭐⭐

### 自动资源管理（Java 7+）

```java
import java.io.*;

public class TryWithResourcesDemo {
    // 推荐写法：自动关闭资源 ⭐⭐⭐⭐⭐
    public static void readFile(String fileName) {
        try (FileReader reader = new FileReader(fileName);
             BufferedReader br = new BufferedReader(reader)) {
            
            String line;
            while ((line = br.readLine()) != null) {
                System.out.println(line);
            }
            
        } catch (FileNotFoundException e) {
            System.out.println("文件未找到：" + fileName);
        } catch (IOException e) {
            System.out.println("读取错误：" + e.getMessage());
        }
        // 资源会自动关闭，不需要finally
    }
    
    // Java 9+ 改进 ⭐⭐⭐⭐
    public static void readFileJava9(String fileName) throws IOException {
        FileReader reader = new FileReader(fileName);
        
        // 可以使用已存在的资源变量
        try (reader) {
            // 使用reader
        }
    }
    
    public static void main(String[] args) {
        readFile("test.txt");
    }
}
```

## 4. 抛出异常 ⭐⭐⭐⭐⭐

### throw和throws

```java
public class ThrowDemo {
    /**
     * throws: 声明方法可能抛出的异常 ⭐⭐⭐⭐⭐
     */
    public static void checkAge(int age) throws IllegalArgumentException {
        if (age < 0 || age > 150) {
            // throw: 主动抛出异常 ⭐⭐⭐⭐⭐
            throw new IllegalArgumentException("年龄必须在0-150之间");
        }
        System.out.println("年龄合法：" + age);
    }
    
    /**
     * 声明多个异常
     */
    public static void readFile(String fileName) 
            throws FileNotFoundException, IOException {
        FileReader reader = new FileReader(fileName);
        reader.read();
        reader.close();
    }
    
    public static void main(String[] args) {
        // 调用抛出异常的方法，必须处理 ⭐⭐⭐⭐⭐
        try {
            checkAge(200);
        } catch (IllegalArgumentException e) {
            System.out.println("异常：" + e.getMessage());
        }
        
        // 或者继续向上抛出
        // public static void main(String[] args) throws Exception {
        //     checkAge(200);
        // }
    }
}
```

### 异常链 ⭐⭐⭐⭐

```java
public class ExceptionChain {
    public static void method1() throws Exception {
        try {
            method2();
        } catch (Exception e) {
            // 包装异常并抛出，保留原始异常信息 ⭐⭐⭐⭐
            throw new Exception("method1发生错误", e);
        }
    }
    
    public static void method2() throws Exception {
        try {
            int result = 10 / 0;
        } catch (ArithmeticException e) {
            throw new Exception("method2计算错误", e);
        }
    }
    
    public static void main(String[] args) {
        try {
            method1();
        } catch (Exception e) {
            System.out.println("异常消息：" + e.getMessage());
            System.out.println("\n完整异常链：");
            e.printStackTrace();
            
            // 获取原始异常
            Throwable cause = e.getCause();
            System.out.println("\n原始异常：" + cause);
        }
    }
}
```

## 5. 自定义异常 ⭐⭐⭐⭐⭐

### 自定义异常类

```java
/**
 * 自定义运行时异常（非受检异常） ⭐⭐⭐⭐⭐
 */
class InsufficientBalanceException extends RuntimeException {
    private double balance;
    private double amount;
    
    public InsufficientBalanceException(double balance, double amount) {
        super("余额不足！当前余额：" + balance + "，需要：" + amount);
        this.balance = balance;
        this.amount = amount;
    }
    
    public double getBalance() {
        return balance;
    }
    
    public double getAmount() {
        return amount;
    }
}

/**
 * 自定义编译时异常（受检异常） ⭐⭐⭐⭐
 */
class InvalidAccountException extends Exception {
    public InvalidAccountException(String message) {
        super(message);
    }
    
    public InvalidAccountException(String message, Throwable cause) {
        super(message, cause);
    }
}

/**
 * 银行账户类
 */
class BankAccount {
    private String accountNumber;
    private double balance;
    
    public BankAccount(String accountNumber, double balance) 
            throws InvalidAccountException {
        if (accountNumber == null || accountNumber.trim().isEmpty()) {
            throw new InvalidAccountException("账号不能为空");
        }
        this.accountNumber = accountNumber;
        this.balance = balance;
    }
    
    /**
     * 取款
     */
    public void withdraw(double amount) {
        if (amount > balance) {
            throw new InsufficientBalanceException(balance, amount);
        }
        balance -= amount;
        System.out.println("取款成功！剩余：" + balance);
    }
    
    public double getBalance() {
        return balance;
    }
}

/**
 * 测试自定义异常
 */
public class CustomExceptionDemo {
    public static void main(String[] args) {
        try {
            // 测试正常账户
            BankAccount account = new BankAccount("1001", 1000);
            account.withdraw(500);
            System.out.println("当前余额：" + account.getBalance());
            
            // 测试余额不足
            account.withdraw(800);
            
        } catch (InvalidAccountException e) {
            System.out.println("账户异常：" + e.getMessage());
        } catch (InsufficientBalanceException e) {
            System.out.println("余额不足异常：" + e.getMessage());
            System.out.println("当前余额：" + e.getBalance());
            System.out.println("需要金额：" + e.getAmount());
        }
        
        // 测试无效账户
        try {
            BankAccount invalidAccount = new BankAccount("", 1000);
        } catch (InvalidAccountException e) {
            System.out.println("创建账户失败：" + e.getMessage());
        }
    }
}
```

## 6. 异常处理最佳实践 ⭐⭐⭐⭐⭐

### 1. 具体异常优于通用异常

```java
public class ExceptionBestPractice {
    // ❌ 不推荐：捕获通用异常
    public void badExample() {
        try {
            // 代码...
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // ✅ 推荐：捕获具体异常
    public void goodExample() {
        try {
            // 代码...
        } catch (FileNotFoundException e) {
            System.out.println("文件未找到");
        } catch (IOException e) {
            System.out.println("IO异常");
        }
    }
}
```

### 2. 不要吞掉异常 ⭐⭐⭐⭐⭐

```java
public class DontSwallowException {
    // ❌ 不推荐：空catch块
    public void badExample() {
        try {
            // 可能出错的代码
        } catch (Exception e) {
            // 什么都不做 - 异常被吞掉了！
        }
    }
    
    // ✅ 推荐：至少记录日志
    public void goodExample() {
        try {
            // 可能出错的代码
        } catch (Exception e) {
            // 记录日志
            System.err.println("错误：" + e.getMessage());
            e.printStackTrace();
            // 或者使用日志框架
            // logger.error("处理失败", e);
        }
    }
}
```

### 3. 合理使用受检异常和非受检异常 ⭐⭐⭐⭐⭐

```java
public class CheckedVsUnchecked {
    /**
     * 受检异常（Checked Exception）：
     * - 用于可恢复的错误
     * - 调用者必须处理
     */
    public void readConfig(String fileName) throws IOException {
        // 文件可能不存在，但可以处理
    }
    
    /**
     * 非受检异常（Unchecked Exception）：
     * - 用于编程错误
     * - 不强制处理
     */
    public void setAge(int age) {
        if (age < 0) {
            // 参数错误，是编程问题
            throw new IllegalArgumentException("年龄不能为负数");
        }
    }
}
```

### 4. 提供有用的异常信息 ⭐⭐⭐⭐⭐

```java
public class UsefulExceptionMessage {
    // ❌ 不推荐：信息不明确
    public void badExample(String userId) {
        if (userId == null) {
            throw new IllegalArgumentException("参数错误");
        }
    }
    
    // ✅ 推荐：提供详细信息
    public void goodExample(String userId) {
        if (userId == null) {
            throw new IllegalArgumentException(
                "用户ID不能为空，请提供有效的用户ID"
            );
        }
        if (userId.trim().isEmpty()) {
            throw new IllegalArgumentException(
                "用户ID不能为空字符串，当前值：'" + userId + "'"
            );
        }
    }
}
```

### 5. 使用try-with-resources ⭐⭐⭐⭐⭐

```java
import java.io.*;

public class ResourceManagement {
    // ❌ 不推荐：手动关闭资源
    public void badExample() throws IOException {
        BufferedReader reader = null;
        try {
            reader = new BufferedReader(new FileReader("file.txt"));
            // 使用reader
        } finally {
            if (reader != null) {
                reader.close();
            }
        }
    }
    
    // ✅ 推荐：自动资源管理
    public void goodExample() throws IOException {
        try (BufferedReader reader = new BufferedReader(
                new FileReader("file.txt"))) {
            // 使用reader，自动关闭
        }
    }
}
```

## 💡 重点总结

### 异常分类 ⭐⭐⭐⭐⭐

1. **受检异常（Checked Exception）**：
   - 必须处理（try-catch或throws）
   - 继承自Exception但不是RuntimeException
   - 例如：IOException, SQLException

2. **非受检异常（Unchecked Exception）**：
   - 不强制处理
   - 继承自RuntimeException
   - 例如：NullPointerException, IllegalArgumentException

3. **错误（Error）**：
   - 不应该捕获
   - 系统级问题
   - 例如：OutOfMemoryError, StackOverflowError

### 处理原则 ⭐⭐⭐⭐⭐

1. **能处理就处理，不能处理就抛出**
2. **不要捕获后什么都不做**
3. **提供有意义的错误信息**
4. **使用合适的异常类型**
5. **优先使用try-with-resources**

### 常用方法

```java
// 异常对象常用方法 ⭐⭐⭐⭐⭐
try {
    // 代码
} catch (Exception e) {
    e.getMessage();         // 获取错误消息
    e.printStackTrace();    // 打印堆栈信息
    e.getCause();          // 获取原因异常
    e.toString();          // 转为字符串
}
```

## 🎯 练习建议

1. 实现一个输入验证工具类（使用自定义异常）
2. 编写文件读写程序（使用try-with-resources）
3. 实现一个简单的登录系统（异常处理）
4. 设计一个购物车系统（异常设计）

## 📚 下一步

完成Java基础部分学习后，继续进入 [Java进阶](../02-Java进阶/) 阶段的学习！

