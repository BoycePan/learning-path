# åå°„ä¸åŠ¨æ€ä»£ç†

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç†è§£åå°„çš„æ¦‚å¿µå’ŒåŸç†
- æŒæ¡Classç±»çš„ä½¿ç”¨
- ç†Ÿç»ƒä½¿ç”¨åå°„API
- ç†è§£åŠ¨æ€ä»£ç†æœºåˆ¶
- æŒæ¡JDKåŠ¨æ€ä»£ç†å’ŒCGLIB

## â­ æ ¸å¿ƒæ¦‚å¿µ

- **Classå¯¹è±¡** â­â­â­â­â­
- **åå°„API** â­â­â­â­â­
- **JDKåŠ¨æ€ä»£ç†** â­â­â­â­â­
- **CGLIBä»£ç†** â­â­â­â­â­
- **åº”ç”¨åœºæ™¯** â­â­â­â­â­

## 1. åå°„åŸºç¡€ â­â­â­â­â­

### ä»€ä¹ˆæ˜¯åå°„ï¼Ÿ

åå°„ï¼ˆReflectionï¼‰æ˜¯Javaçš„ä¸€ç§**è¿è¡Œæ—¶æœºåˆ¶**ï¼Œå…è®¸ç¨‹åºåœ¨è¿è¡Œæ—¶ï¼š
1. **æ£€æŸ¥ç±»çš„ç»“æ„** - è·å–ç±»çš„å­—æ®µã€æ–¹æ³•ã€æ„é€ å™¨
2. **åˆ›å»ºå¯¹è±¡** - åŠ¨æ€åˆ›å»ºç±»çš„å®ä¾‹
3. **è°ƒç”¨æ–¹æ³•** - åŠ¨æ€è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•
4. **è®¿é—®å­—æ®µ** - åŠ¨æ€è¯»å†™å¯¹è±¡çš„å­—æ®µ

**åº”ç”¨åœºæ™¯**ï¼š
- **æ¡†æ¶å¼€å‘** - Spring IoCã€MyBatis
- **åºåˆ—åŒ–/ååºåˆ—åŒ–** - JSONã€XML
- **åŠ¨æ€ä»£ç†** - AOP
- **æ³¨è§£å¤„ç†** - è¿è¡Œæ—¶å¤„ç†æ³¨è§£

### è·å–Classå¯¹è±¡ â­â­â­â­â­

```java
public class User {
    private String name;
    private int age;
    
    public User() {}
    
    public User(String name, int age) {
        this.name = name;
        this.age = age;
    }
    
    public void sayHello() {
        System.out.println("Hello, I'm " + name);
    }
}

public class ReflectionDemo {
    public static void main(String[] args) throws Exception {
        // æ–¹å¼1ï¼šé€šè¿‡ç±»å.class â­â­â­â­â­
        Class<User> clazz1 = User.class;
        
        // æ–¹å¼2ï¼šé€šè¿‡å¯¹è±¡.getClass() â­â­â­â­â­
        User user = new User();
        Class<?> clazz2 = user.getClass();
        
        // æ–¹å¼3ï¼šé€šè¿‡Class.forName() â­â­â­â­â­
        Class<?> clazz3 = Class.forName("com.example.User");
        
        // ä¸‰ç§æ–¹å¼è·å–çš„æ˜¯åŒä¸€ä¸ªClasså¯¹è±¡
        System.out.println(clazz1 == clazz2);  // true
        System.out.println(clazz2 == clazz3);  // true
        
        // è·å–ç±»ä¿¡æ¯
        System.out.println("ç±»åï¼š" + clazz1.getName());
        System.out.println("ç®€å•ç±»åï¼š" + clazz1.getSimpleName());
        System.out.println("åŒ…åï¼š" + clazz1.getPackage().getName());
    }
}
```

## 2. åå°„æ“ä½œæ„é€ å™¨ â­â­â­â­â­

```java
import java.lang.reflect.Constructor;

public class ConstructorDemo {
    public static void main(String[] args) throws Exception {
        Class<User> clazz = User.class;
        
        // è·å–æ‰€æœ‰publicæ„é€ å™¨ â­â­â­â­â­
        Constructor<?>[] constructors = clazz.getConstructors();
        for (Constructor<?> constructor : constructors) {
            System.out.println(constructor);
        }
        
        // è·å–æ‰€æœ‰æ„é€ å™¨ï¼ˆåŒ…æ‹¬privateï¼‰
        Constructor<?>[] allConstructors = clazz.getDeclaredConstructors();
        
        // è·å–æ— å‚æ„é€ å™¨ â­â­â­â­â­
        Constructor<User> constructor1 = clazz.getConstructor();
        User user1 = constructor1.newInstance();
        
        // è·å–æœ‰å‚æ„é€ å™¨ â­â­â­â­â­
        Constructor<User> constructor2 = clazz.getConstructor(String.class, int.class);
        User user2 = constructor2.newInstance("Alice", 25);
        
        // ç®€åŒ–æ–¹å¼ï¼ˆæ¨èï¼‰â­â­â­â­â­
        User user3 = clazz.getDeclaredConstructor().newInstance();
    }
}

// ç§æœ‰æ„é€ å™¨ç¤ºä¾‹
public class Singleton {
    private static Singleton instance = new Singleton();
    
    private Singleton() {}
    
    public static Singleton getInstance() {
        return instance;
    }
}

// é€šè¿‡åå°„ç ´åå•ä¾‹
public class BreakSingleton {
    public static void main(String[] args) throws Exception {
        Singleton s1 = Singleton.getInstance();
        
        // è·å–ç§æœ‰æ„é€ å™¨
        Constructor<Singleton> constructor = Singleton.class.getDeclaredConstructor();
        constructor.setAccessible(true);  // ç ´åè®¿é—®æƒé™ â­â­â­â­â­
        Singleton s2 = constructor.newInstance();
        
        System.out.println(s1 == s2);  // falseï¼Œå•ä¾‹è¢«ç ´å
    }
}
```

## 3. åå°„æ“ä½œå­—æ®µ â­â­â­â­â­

```java
import java.lang.reflect.Field;

public class FieldDemo {
    public static void main(String[] args) throws Exception {
        Class<User> clazz = User.class;
        User user = new User("Bob", 30);
        
        // è·å–æ‰€æœ‰publicå­—æ®µ
        Field[] fields = clazz.getFields();
        
        // è·å–æ‰€æœ‰å­—æ®µï¼ˆåŒ…æ‹¬privateï¼‰â­â­â­â­â­
        Field[] allFields = clazz.getDeclaredFields();
        for (Field field : allFields) {
            System.out.println(field.getName() + " : " + field.getType());
        }
        
        // è·å–æŒ‡å®šå­—æ®µ â­â­â­â­â­
        Field nameField = clazz.getDeclaredField("name");
        nameField.setAccessible(true);  // è®¿é—®ç§æœ‰å­—æ®µ
        
        // è¯»å–å­—æ®µå€¼ â­â­â­â­â­
        String name = (String) nameField.get(user);
        System.out.println("name = " + name);  // Bob
        
        // ä¿®æ”¹å­—æ®µå€¼ â­â­â­â­â­
        nameField.set(user, "Charlie");
        System.out.println("ä¿®æ”¹åï¼š" + user.getName());  // Charlie
        
        // è·å–å­—æ®µä¿®é¥°ç¬¦
        int modifiers = nameField.getModifiers();
        System.out.println("æ˜¯å¦privateï¼š" + java.lang.reflect.Modifier.isPrivate(modifiers));
    }
}

// å®ç”¨å·¥å…·ï¼šå¯¹è±¡å¤åˆ¶
public class BeanUtils {
    public static void copyProperties(Object source, Object target) throws Exception {
        Class<?> sourceClass = source.getClass();
        Class<?> targetClass = target.getClass();
        
        Field[] fields = sourceClass.getDeclaredFields();
        for (Field field : fields) {
            field.setAccessible(true);
            
            try {
                Field targetField = targetClass.getDeclaredField(field.getName());
                targetField.setAccessible(true);
                
                Object value = field.get(source);
                targetField.set(target, value);
            } catch (NoSuchFieldException e) {
                // ç›®æ ‡å¯¹è±¡æ²¡æœ‰è¯¥å­—æ®µï¼Œè·³è¿‡
            }
        }
    }
}
```

## 4. åå°„æ“ä½œæ–¹æ³• â­â­â­â­â­

```java
import java.lang.reflect.Method;

public class MethodDemo {
    public static void main(String[] args) throws Exception {
        Class<User> clazz = User.class;
        User user = new User("David", 28);
        
        // è·å–æ‰€æœ‰publicæ–¹æ³•ï¼ˆåŒ…æ‹¬ç»§æ‰¿çš„ï¼‰â­â­â­â­â­
        Method[] methods = clazz.getMethods();
        
        // è·å–æ‰€æœ‰æ–¹æ³•ï¼ˆåŒ…æ‹¬privateï¼Œä¸åŒ…æ‹¬ç»§æ‰¿çš„ï¼‰
        Method[] allMethods = clazz.getDeclaredMethods();
        
        for (Method method : allMethods) {
            System.out.println(method.getName());
        }
        
        // è·å–æŒ‡å®šæ–¹æ³• â­â­â­â­â­
        Method sayHelloMethod = clazz.getMethod("sayHello");
        
        // è°ƒç”¨æ–¹æ³• â­â­â­â­â­
        sayHelloMethod.invoke(user);  // Hello, I'm David
        
        // è·å–å¸¦å‚æ•°çš„æ–¹æ³•
        Method setNameMethod = clazz.getMethod("setName", String.class);
        setNameMethod.invoke(user, "Eve");
        
        // è·å–æ–¹æ³•è¿”å›å€¼
        Method getNameMethod = clazz.getMethod("getName");
        String name = (String) getNameMethod.invoke(user);
        System.out.println("name = " + name);  // Eve
        
        // è°ƒç”¨ç§æœ‰æ–¹æ³•
        Method privateMethod = clazz.getDeclaredMethod("privateMethod");
        privateMethod.setAccessible(true);
        privateMethod.invoke(user);
    }
}

// å®ç”¨å·¥å…·ï¼šæ–¹æ³•è°ƒç”¨å·¥å…·
public class MethodInvoker {
    public static Object invoke(Object obj, String methodName, Object... args) 
            throws Exception {
        Class<?> clazz = obj.getClass();
        
        // è·å–å‚æ•°ç±»å‹
        Class<?>[] paramTypes = new Class[args.length];
        for (int i = 0; i < args.length; i++) {
            paramTypes[i] = args[i].getClass();
        }
        
        // è·å–æ–¹æ³•
        Method method = clazz.getMethod(methodName, paramTypes);
        
        // è°ƒç”¨æ–¹æ³•
        return method.invoke(obj, args);
    }
}
```

## 5. JDKåŠ¨æ€ä»£ç† â­â­â­â­â­

### ä»€ä¹ˆæ˜¯åŠ¨æ€ä»£ç†ï¼Ÿ

åŠ¨æ€ä»£ç†æ˜¯åœ¨**è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä»£ç†ç±»**ï¼Œç”¨äºï¼š
1. **AOP** - é¢å‘åˆ‡é¢ç¼–ç¨‹
2. **æ—¥å¿—è®°å½•** - æ–¹æ³•è°ƒç”¨æ—¥å¿—
3. **æ€§èƒ½ç›‘æ§** - æ–¹æ³•æ‰§è¡Œæ—¶é—´
4. **æƒé™æ§åˆ¶** - æ–¹æ³•è®¿é—®æƒé™

### JDKåŠ¨æ€ä»£ç†å®ç° â­â­â­â­â­

```java
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;
import java.lang.reflect.Proxy;

// 1. å®šä¹‰æ¥å£ï¼ˆJDKåŠ¨æ€ä»£ç†å¿…é¡»åŸºäºæ¥å£ï¼‰â­â­â­â­â­
public interface UserService {
    void save(User user);
    User findById(Long id);
    void delete(Long id);
}

// 2. å®ç°ç±»
public class UserServiceImpl implements UserService {
    @Override
    public void save(User user) {
        System.out.println("ä¿å­˜ç”¨æˆ·ï¼š" + user.getName());
    }
    
    @Override
    public User findById(Long id) {
        System.out.println("æŸ¥è¯¢ç”¨æˆ·ï¼š" + id);
        return new User("User" + id, 25);
    }
    
    @Override
    public void delete(Long id) {
        System.out.println("åˆ é™¤ç”¨æˆ·ï¼š" + id);
    }
}

// 3. åˆ›å»ºInvocationHandler â­â­â­â­â­
public class LogInvocationHandler implements InvocationHandler {
    private Object target;  // è¢«ä»£ç†å¯¹è±¡
    
    public LogInvocationHandler(Object target) {
        this.target = target;
    }
    
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        // å‰ç½®å¢å¼º
        System.out.println("=== æ–¹æ³•è°ƒç”¨å¼€å§‹ ===");
        System.out.println("æ–¹æ³•åï¼š" + method.getName());
        System.out.println("å‚æ•°ï¼š" + Arrays.toString(args));
        long startTime = System.currentTimeMillis();
        
        // è°ƒç”¨ç›®æ ‡æ–¹æ³•
        Object result = method.invoke(target, args);
        
        // åç½®å¢å¼º
        long endTime = System.currentTimeMillis();
        System.out.println("æ‰§è¡Œæ—¶é—´ï¼š" + (endTime - startTime) + "ms");
        System.out.println("è¿”å›å€¼ï¼š" + result);
        System.out.println("=== æ–¹æ³•è°ƒç”¨ç»“æŸ ===\n");
        
        return result;
    }
}

// 4. åˆ›å»ºä»£ç†å¯¹è±¡ â­â­â­â­â­
public class ProxyDemo {
    public static void main(String[] args) {
        // åˆ›å»ºç›®æ ‡å¯¹è±¡
        UserService target = new UserServiceImpl();
        
        // åˆ›å»ºä»£ç†å¯¹è±¡
        UserService proxy = (UserService) Proxy.newProxyInstance(
            target.getClass().getClassLoader(),  // ç±»åŠ è½½å™¨
            target.getClass().getInterfaces(),   // æ¥å£æ•°ç»„
            new LogInvocationHandler(target)     // InvocationHandler
        );
        
        // ä½¿ç”¨ä»£ç†å¯¹è±¡
        proxy.save(new User("Alice", 25));
        User user = proxy.findById(1L);
        proxy.delete(1L);
    }
}
```

### ä»£ç†å·¥å‚æ¨¡å¼ â­â­â­â­â­

```java
public class ProxyFactory {
    
    public static <T> T createProxy(T target) {
        return (T) Proxy.newProxyInstance(
            target.getClass().getClassLoader(),
            target.getClass().getInterfaces(),
            new LogInvocationHandler(target)
        );
    }
    
    // ä½¿ç”¨
    public static void main(String[] args) {
        UserService userService = new UserServiceImpl();
        UserService proxy = ProxyFactory.createProxy(userService);
        proxy.save(new User("Bob", 30));
    }
}
```

## 6. CGLIBåŠ¨æ€ä»£ç† â­â­â­â­â­

### CGLIB vs JDKåŠ¨æ€ä»£ç†

| ç‰¹æ€§ | JDKåŠ¨æ€ä»£ç† | CGLIB |
|------|------------|-------|
| å®ç°æ–¹å¼ | åŸºäºæ¥å£ â­â­â­â­â­ | åŸºäºç»§æ‰¿ â­â­â­â­â­ |
| è¦æ±‚ | å¿…é¡»æœ‰æ¥å£ | ä¸èƒ½æ˜¯finalç±» |
| æ€§èƒ½ | è¾ƒæ…¢ | è¾ƒå¿« |
| ä½¿ç”¨åœºæ™¯ | Spring AOPï¼ˆæœ‰æ¥å£ï¼‰ | Spring AOPï¼ˆæ— æ¥å£ï¼‰ |

### CGLIBå®ç° â­â­â­â­â­

```java
import net.sf.cglib.proxy.Enhancer;
import net.sf.cglib.proxy.MethodInterceptor;
import net.sf.cglib.proxy.MethodProxy;

// 1. ç›®æ ‡ç±»ï¼ˆä¸éœ€è¦æ¥å£ï¼‰
public class UserService {
    public void save(User user) {
        System.out.println("ä¿å­˜ç”¨æˆ·ï¼š" + user.getName());
    }
    
    public User findById(Long id) {
        System.out.println("æŸ¥è¯¢ç”¨æˆ·ï¼š" + id);
        return new User("User" + id, 25);
    }
}

// 2. åˆ›å»ºMethodInterceptor â­â­â­â­â­
public class LogMethodInterceptor implements MethodInterceptor {
    
    @Override
    public Object intercept(Object obj, Method method, Object[] args, 
                          MethodProxy proxy) throws Throwable {
        // å‰ç½®å¢å¼º
        System.out.println("=== CGLIBä»£ç†å¼€å§‹ ===");
        System.out.println("æ–¹æ³•åï¼š" + method.getName());
        
        // è°ƒç”¨ç›®æ ‡æ–¹æ³•
        Object result = proxy.invokeSuper(obj, args);
        
        // åç½®å¢å¼º
        System.out.println("=== CGLIBä»£ç†ç»“æŸ ===\n");
        
        return result;
    }
}

// 3. åˆ›å»ºä»£ç†å¯¹è±¡ â­â­â­â­â­
public class CglibProxyDemo {
    public static void main(String[] args) {
        // åˆ›å»ºEnhancerå¯¹è±¡
        Enhancer enhancer = new Enhancer();
        
        // è®¾ç½®çˆ¶ç±»
        enhancer.setSuperclass(UserService.class);
        
        // è®¾ç½®å›è°ƒ
        enhancer.setCallback(new LogMethodInterceptor());
        
        // åˆ›å»ºä»£ç†å¯¹è±¡
        UserService proxy = (UserService) enhancer.create();
        
        // ä½¿ç”¨ä»£ç†å¯¹è±¡
        proxy.save(new User("Charlie", 28));
        proxy.findById(1L);
    }
}
```

## 7. å®æˆ˜åº”ç”¨ â­â­â­â­â­

### 1. ç®€æ˜“ORMæ¡†æ¶

```java
public class SimpleORM {
    
    // å°†ResultSetè½¬æ¢ä¸ºå¯¹è±¡
    public static <T> T resultSetToObject(ResultSet rs, Class<T> clazz) 
            throws Exception {
        T obj = clazz.getDeclaredConstructor().newInstance();
        
        Field[] fields = clazz.getDeclaredFields();
        for (Field field : fields) {
            field.setAccessible(true);
            String columnName = field.getName();
            Object value = rs.getObject(columnName);
            field.set(obj, value);
        }
        
        return obj;
    }
    
    // å°†å¯¹è±¡è½¬æ¢ä¸ºSQL
    public static String objectToInsertSQL(Object obj) throws Exception {
        Class<?> clazz = obj.getClass();
        String tableName = clazz.getSimpleName().toLowerCase();
        
        StringBuilder columns = new StringBuilder();
        StringBuilder values = new StringBuilder();
        
        Field[] fields = clazz.getDeclaredFields();
        for (int i = 0; i < fields.length; i++) {
            fields[i].setAccessible(true);
            
            if (i > 0) {
                columns.append(", ");
                values.append(", ");
            }
            
            columns.append(fields[i].getName());
            Object value = fields[i].get(obj);
            values.append("'").append(value).append("'");
        }
        
        return String.format("INSERT INTO %s (%s) VALUES (%s)", 
                           tableName, columns, values);
    }
}
```

### 2. æ€§èƒ½ç›‘æ§ä»£ç†

```java
public class PerformanceMonitor implements InvocationHandler {
    private Object target;
    
    public PerformanceMonitor(Object target) {
        this.target = target;
    }
    
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) 
            throws Throwable {
        long startTime = System.nanoTime();
        
        Object result = method.invoke(target, args);
        
        long endTime = System.nanoTime();
        long duration = (endTime - startTime) / 1_000_000;  // è½¬æ¢ä¸ºæ¯«ç§’
        
        if (duration > 100) {  // è¶…è¿‡100msè®°å½•
            System.out.println(String.format(
                "æ…¢æ–¹æ³•è­¦å‘Šï¼š%s.%s æ‰§è¡Œæ—¶é—´ï¼š%dms",
                target.getClass().getSimpleName(),
                method.getName(),
                duration
            ));
        }
        
        return result;
    }
}
```

### 3. äº‹åŠ¡ä»£ç†

```java
public class TransactionProxy implements InvocationHandler {
    private Object target;
    
    public TransactionProxy(Object target) {
        this.target = target;
    }
    
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) 
            throws Throwable {
        // æ£€æŸ¥æ˜¯å¦æœ‰@Transactionalæ³¨è§£
        if (method.isAnnotationPresent(Transactional.class)) {
            System.out.println("å¼€å¯äº‹åŠ¡");
            try {
                Object result = method.invoke(target, args);
                System.out.println("æäº¤äº‹åŠ¡");
                return result;
            } catch (Exception e) {
                System.out.println("å›æ»šäº‹åŠ¡");
                throw e;
            }
        } else {
            return method.invoke(target, args);
        }
    }
}

@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@interface Transactional {
}
```

## ğŸ’¡ æœ€ä½³å®è·µ â­â­â­â­â­

### 1. åå°„æ€§èƒ½ä¼˜åŒ–

```java
// ç¼“å­˜Classå¯¹è±¡å’ŒMethodå¯¹è±¡
public class ReflectionCache {
    private static final Map<String, Class<?>> classCache = new ConcurrentHashMap<>();
    private static final Map<String, Method> methodCache = new ConcurrentHashMap<>();
    
    public static Class<?> getClass(String className) throws ClassNotFoundException {
        return classCache.computeIfAbsent(className, k -> {
            try {
                return Class.forName(k);
            } catch (ClassNotFoundException e) {
                throw new RuntimeException(e);
            }
        });
    }
}
```

### 2. å®‰å…¨ä½¿ç”¨åå°„

```java
// æ£€æŸ¥æƒé™
SecurityManager sm = System.getSecurityManager();
if (sm != null) {
    sm.checkPermission(new ReflectPermission("suppressAccessChecks"));
}

// ä½¿ç”¨try-finallyç¡®ä¿æ¢å¤è®¿é—®æƒé™
Field field = clazz.getDeclaredField("name");
boolean accessible = field.isAccessible();
try {
    field.setAccessible(true);
    // æ“ä½œå­—æ®µ
} finally {
    field.setAccessible(accessible);
}
```

## ğŸ¯ å®æˆ˜ç»ƒä¹ 

1. å®ç°ä¸€ä¸ªç®€å•çš„ä¾èµ–æ³¨å…¥å®¹å™¨
2. åˆ›å»ºä¸€ä¸ªé€šç”¨çš„DAOå±‚
3. å®ç°æ–¹æ³•è°ƒç”¨æ—¥å¿—è®°å½•
4. ç¼–å†™ä¸€ä¸ªå¯¹è±¡éªŒè¯æ¡†æ¶

## ğŸ“š ä¸‹ä¸€æ­¥

å­¦ä¹ å®Œåå°„ä¸åŠ¨æ€ä»£ç†åï¼Œç»§ç»­å­¦ä¹ ï¼š
- [æ³¨è§£å¤„ç†å™¨](./æ³›å‹ä¸æ³¨è§£.md)
- [Spring AOPåŸç†](../04-Springç”Ÿæ€/Springæ ¸å¿ƒ.md)

