# é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡

## ğŸ“Œ å­¦ä¹ ç›®æ ‡

- ç†è§£é«˜å¹¶å‘ç³»ç»Ÿçš„æ ¸å¿ƒæŒ‘æˆ˜
- æŒæ¡é™æµã€é™çº§ã€ç†”æ–­çš„è®¾è®¡ä¸å®ç°
- å­¦ä¼šè®¾è®¡é«˜å¹¶å‘æ¶æ„
- æŒæ¡å¸¸è§çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µ
- ç†è§£ç¼“å­˜ã€å¼‚æ­¥ã€å‰Šå³°å¡«è°·ç­‰ç­–ç•¥

## â­ å­¦ä¹ å»ºè®®

**é€‚åˆå­¦ä¹ é˜¶æ®µ**ï¼šå®Œæˆå¾®æœåŠ¡å­¦ä¹ å â­â­â­â­â­

**å‰ç½®çŸ¥è¯†**ï¼š
- å¾®æœåŠ¡æ¶æ„ â­â­â­â­â­
- Redisç¼“å­˜ â­â­â­â­â­
- æ¶ˆæ¯é˜Ÿåˆ— â­â­â­â­â­
- å¤šçº¿ç¨‹å¹¶å‘ â­â­â­â­â­

## 1. é«˜å¹¶å‘ç³»ç»Ÿæ¦‚è¿° â­â­â­â­â­

### ä»€ä¹ˆæ˜¯é«˜å¹¶å‘ï¼Ÿ

```
é«˜å¹¶å‘ï¼ˆHigh Concurrencyï¼‰ï¼š
ç³»ç»Ÿèƒ½å¤ŸåŒæ—¶å¤„ç†å¤§é‡è¯·æ±‚çš„èƒ½åŠ›

è¡¡é‡æŒ‡æ ‡ï¼š
- QPSï¼ˆQueries Per Secondï¼‰ï¼šæ¯ç§’æŸ¥è¯¢æ•°
- TPSï¼ˆTransactions Per Secondï¼‰ï¼šæ¯ç§’äº‹åŠ¡æ•°
- å¹¶å‘ç”¨æˆ·æ•°ï¼šåŒæ—¶åœ¨çº¿ç”¨æˆ·æ•°
- å“åº”æ—¶é—´ï¼šP99ã€P95ã€P50

é«˜å¹¶å‘çº§åˆ«ï¼š
- ä½å¹¶å‘ï¼š< 1000 QPS
- ä¸­å¹¶å‘ï¼š1000 - 10000 QPS
- é«˜å¹¶å‘ï¼š10000 - 100000 QPS
- è¶…é«˜å¹¶å‘ï¼š> 100000 QPS
```

### é«˜å¹¶å‘ç³»ç»Ÿçš„æŒ‘æˆ˜

```
1. æ€§èƒ½æŒ‘æˆ˜
   - å“åº”æ—¶é—´è¦æ±‚é«˜ï¼ˆ< 200msï¼‰
   - ååé‡è¦æ±‚é«˜ï¼ˆ> 10000 QPSï¼‰
   - èµ„æºæ¶ˆè€—è¦æ§åˆ¶

2. å¯ç”¨æ€§æŒ‘æˆ˜
   - ç³»ç»Ÿä¸èƒ½å®•æœºï¼ˆ99.99%å¯ç”¨æ€§ï¼‰
   - æ•…éšœå¿«é€Ÿæ¢å¤
   - é™çº§ä¿æŠ¤

3. æ•°æ®ä¸€è‡´æ€§æŒ‘æˆ˜
   - åˆ†å¸ƒå¼äº‹åŠ¡
   - ç¼“å­˜ä¸€è‡´æ€§
   - æœ€ç»ˆä¸€è‡´æ€§

4. æ‰©å±•æ€§æŒ‘æˆ˜
   - æ”¯æŒæ°´å¹³æ‰©å±•
   - æ— çŠ¶æ€è®¾è®¡
   - å¼¹æ€§ä¼¸ç¼©
```

## 2. é™æµï¼ˆRate Limitingï¼‰â­â­â­â­â­

### é™æµç®—æ³•

**1. å›ºå®šçª—å£ç®—æ³•**

```java
public class FixedWindowRateLimiter {
    private final int limit;  // é™æµé˜ˆå€¼
    private final long windowSize;  // çª—å£å¤§å°ï¼ˆæ¯«ç§’ï¼‰
    private AtomicInteger counter = new AtomicInteger(0);
    private long windowStart = System.currentTimeMillis();
    
    public FixedWindowRateLimiter(int limit, long windowSize) {
        this.limit = limit;
        this.windowSize = windowSize;
    }
    
    public synchronized boolean tryAcquire() {
        long now = System.currentTimeMillis();
        
        // çª—å£è¿‡æœŸï¼Œé‡ç½®è®¡æ•°å™¨
        if (now - windowStart >= windowSize) {
            counter.set(0);
            windowStart = now;
        }
        
        // åˆ¤æ–­æ˜¯å¦è¶…è¿‡é™æµé˜ˆå€¼
        if (counter.get() < limit) {
            counter.incrementAndGet();
            return true;
        }
        
        return false;
    }
}
```

**2. æ»‘åŠ¨çª—å£ç®—æ³•**

```java
public class SlidingWindowRateLimiter {
    private final int limit;
    private final long windowSize;
    private final Queue<Long> timestamps = new LinkedList<>();
    
    public SlidingWindowRateLimiter(int limit, long windowSize) {
        this.limit = limit;
        this.windowSize = windowSize;
    }
    
    public synchronized boolean tryAcquire() {
        long now = System.currentTimeMillis();
        
        // ç§»é™¤è¿‡æœŸçš„æ—¶é—´æˆ³
        while (!timestamps.isEmpty() && now - timestamps.peek() >= windowSize) {
            timestamps.poll();
        }
        
        // åˆ¤æ–­æ˜¯å¦è¶…è¿‡é™æµé˜ˆå€¼
        if (timestamps.size() < limit) {
            timestamps.offer(now);
            return true;
        }
        
        return false;
    }
}
```

**3. ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆæ¨èï¼‰**

```java
// ä½¿ç”¨Guavaçš„RateLimiter
import com.google.common.util.concurrent.RateLimiter;

public class TokenBucketExample {
    // æ¯ç§’ç”Ÿæˆ100ä¸ªä»¤ç‰Œ
    private final RateLimiter rateLimiter = RateLimiter.create(100.0);
    
    public void handleRequest() {
        // å°è¯•è·å–ä»¤ç‰Œï¼Œæœ€å¤šç­‰å¾…1ç§’
        if (rateLimiter.tryAcquire(1, TimeUnit.SECONDS)) {
            // å¤„ç†è¯·æ±‚
            processRequest();
        } else {
            // é™æµï¼Œæ‹’ç»è¯·æ±‚
            throw new RateLimitException("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
        }
    }
    
    private void processRequest() {
        // ä¸šåŠ¡é€»è¾‘
    }
}
```

**4. æ¼æ¡¶ç®—æ³•**

```java
public class LeakyBucketRateLimiter {
    private final int capacity;  // æ¡¶å®¹é‡
    private final int rate;  // æ¼å‡ºé€Ÿç‡ï¼ˆæ¯ç§’ï¼‰
    private int water = 0;  // å½“å‰æ°´é‡
    private long lastLeakTime = System.currentTimeMillis();
    
    public LeakyBucketRateLimiter(int capacity, int rate) {
        this.capacity = capacity;
        this.rate = rate;
    }
    
    public synchronized boolean tryAcquire() {
        long now = System.currentTimeMillis();
        
        // è®¡ç®—æ¼å‡ºçš„æ°´é‡
        long elapsedTime = now - lastLeakTime;
        int leaked = (int) (elapsedTime * rate / 1000);
        water = Math.max(0, water - leaked);
        lastLeakTime = now;
        
        // åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ç©ºé—´
        if (water < capacity) {
            water++;
            return true;
        }
        
        return false;
    }
}
```

### åˆ†å¸ƒå¼é™æµï¼ˆRediså®ç°ï¼‰

```java
@Service
public class RedisRateLimiter {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    /**
     * åŸºäºRedisçš„æ»‘åŠ¨çª—å£é™æµ
     * @param key é™æµkey
     * @param limit é™æµé˜ˆå€¼
     * @param windowSize çª—å£å¤§å°ï¼ˆç§’ï¼‰
     * @return æ˜¯å¦å…è®¸é€šè¿‡
     */
    public boolean tryAcquire(String key, int limit, int windowSize) {
        long now = System.currentTimeMillis();
        long windowStart = now - windowSize * 1000;
        
        String redisKey = "rate_limit:" + key;
        
        // ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
        String luaScript = 
            "local key = KEYS[1] " +
            "local now = tonumber(ARGV[1]) " +
            "local windowStart = tonumber(ARGV[2]) " +
            "local limit = tonumber(ARGV[3]) " +
            "local windowSize = tonumber(ARGV[4]) " +
            
            // ç§»é™¤è¿‡æœŸçš„è®°å½•
            "redis.call('zremrangebyscore', key, 0, windowStart) " +
            
            // è·å–å½“å‰çª—å£å†…çš„è¯·æ±‚æ•°
            "local count = redis.call('zcard', key) " +
            
            // åˆ¤æ–­æ˜¯å¦è¶…è¿‡é™æµé˜ˆå€¼
            "if count < limit then " +
            "    redis.call('zadd', key, now, now) " +
            "    redis.call('expire', key, windowSize) " +
            "    return 1 " +
            "else " +
            "    return 0 " +
            "end";
        
        DefaultRedisScript<Long> redisScript = new DefaultRedisScript<>();
        redisScript.setScriptText(luaScript);
        redisScript.setResultType(Long.class);
        
        Long result = redisTemplate.execute(
            redisScript,
            Collections.singletonList(redisKey),
            String.valueOf(now),
            String.valueOf(windowStart),
            String.valueOf(limit),
            String.valueOf(windowSize)
        );
        
        return result != null && result == 1;
    }
}
```

### Sentinelé™æµï¼ˆæ¨èï¼‰

```java
// 1. å¼•å…¥ä¾èµ–
// <dependency>
//     <groupId>com.alibaba.cloud</groupId>
//     <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
// </dependency>

// 2. ä½¿ç”¨@SentinelResourceæ³¨è§£
@Service
public class OrderService {
    
    @SentinelResource(
        value = "createOrder",
        blockHandler = "createOrderBlockHandler",
        fallback = "createOrderFallback"
    )
    public Order createOrder(OrderRequest request) {
        // ä¸šåŠ¡é€»è¾‘
        return new Order();
    }
    
    // é™æµå¤„ç†
    public Order createOrderBlockHandler(OrderRequest request, BlockException ex) {
        throw new BusinessException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");
    }
    
    // é™çº§å¤„ç†
    public Order createOrderFallback(OrderRequest request, Throwable ex) {
        // è¿”å›é»˜è®¤å€¼æˆ–ç¼“å­˜æ•°æ®
        return new Order();
    }
}

// 3. é…ç½®é™æµè§„åˆ™
@Configuration
public class SentinelConfig {
    
    @PostConstruct
    public void initFlowRules() {
        List<FlowRule> rules = new ArrayList<>();
        
        FlowRule rule = new FlowRule();
        rule.setResource("createOrder");
        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
        rule.setCount(100);  // QPSé™åˆ¶ä¸º100
        
        rules.add(rule);
        FlowRuleManager.loadRules(rules);
    }
}
```

## 3. é™çº§ï¼ˆDegradationï¼‰â­â­â­â­â­

### é™çº§ç­–ç•¥

```
1. åŠŸèƒ½é™çº§
   - å…³é—­éæ ¸å¿ƒåŠŸèƒ½
   - ç®€åŒ–ä¸šåŠ¡æµç¨‹
   - è¿”å›é»˜è®¤å€¼

2. è¯»é™çº§
   - è¿”å›ç¼“å­˜æ•°æ®
   - è¿”å›é™æ€æ•°æ®
   - è¿”å›å…œåº•æ•°æ®

3. å†™é™çº§
   - å¼‚æ­¥å†™å…¥
   - æ‰¹é‡å†™å…¥
   - å»¶è¿Ÿå†™å…¥

4. æœåŠ¡é™çº§
   - åœæ­¢è°ƒç”¨éæ ¸å¿ƒæœåŠ¡
   - ä½¿ç”¨Mockæ•°æ®
   - å¿«é€Ÿå¤±è´¥
```

### é™çº§å®ç°

```java
@Service
public class ProductService {
    
    @Autowired
    private ProductClient productClient;
    
    @Autowired
    private RedisTemplate<String, Product> redisTemplate;
    
    /**
     * è·å–å•†å“ä¿¡æ¯ï¼ˆå¸¦é™çº§ï¼‰
     */
    public Product getProduct(Long productId) {
        try {
            // 1. å°è¯•ä»è¿œç¨‹æœåŠ¡è·å–
            return productClient.getProduct(productId);
            
        } catch (Exception e) {
            log.warn("è°ƒç”¨å•†å“æœåŠ¡å¤±è´¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ", e);
            
            // 2. é™çº§æ–¹æ¡ˆ1ï¼šä»ç¼“å­˜è·å–
            Product cachedProduct = redisTemplate.opsForValue()
                .get("product:" + productId);
            if (cachedProduct != null) {
                return cachedProduct;
            }
            
            // 3. é™çº§æ–¹æ¡ˆ2ï¼šè¿”å›é»˜è®¤å•†å“
            return getDefaultProduct(productId);
        }
    }
    
    private Product getDefaultProduct(Long productId) {
        Product product = new Product();
        product.setId(productId);
        product.setName("å•†å“æš‚æ—¶æ— æ³•æŸ¥çœ‹");
        product.setPrice(BigDecimal.ZERO);
        return product;
    }
}
```

## 4. ç†”æ–­ï¼ˆCircuit Breakerï¼‰â­â­â­â­â­

### ç†”æ–­å™¨çŠ¶æ€æœº

```
ç†”æ–­å™¨ä¸‰ç§çŠ¶æ€ï¼š

1. å…³é—­ï¼ˆClosedï¼‰
   - æ­£å¸¸è°ƒç”¨æœåŠ¡
   - ç»Ÿè®¡å¤±è´¥ç‡
   - å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼ â†’ æ‰“å¼€

2. æ‰“å¼€ï¼ˆOpenï¼‰
   - å¿«é€Ÿå¤±è´¥ï¼Œä¸è°ƒç”¨æœåŠ¡
   - ç›´æ¥è¿”å›é”™è¯¯æˆ–é™çº§æ•°æ®
   - ç­‰å¾…ä¸€æ®µæ—¶é—´ â†’ åŠå¼€

3. åŠå¼€ï¼ˆHalf-Openï¼‰
   - å°è¯•è°ƒç”¨æœåŠ¡
   - æˆåŠŸ â†’ å…³é—­
   - å¤±è´¥ â†’ æ‰“å¼€
```

### Sentinelç†”æ–­å®ç°

```java
@Configuration
public class SentinelCircuitBreakerConfig {
    
    @PostConstruct
    public void initDegradeRules() {
        List<DegradeRule> rules = new ArrayList<>();
        
        // æ…¢è°ƒç”¨æ¯”ä¾‹ç†”æ–­
        DegradeRule slowRule = new DegradeRule();
        slowRule.setResource("getProduct");
        slowRule.setGrade(CircuitBreakerStrategy.SLOW_REQUEST_RATIO.getType());
        slowRule.setCount(1000);  // æ…¢è°ƒç”¨é˜ˆå€¼1000ms
        slowRule.setSlowRatioThreshold(0.5);  // æ…¢è°ƒç”¨æ¯”ä¾‹50%
        slowRule.setMinRequestAmount(10);  // æœ€å°è¯·æ±‚æ•°10
        slowRule.setStatIntervalMs(10000);  // ç»Ÿè®¡æ—¶é•¿10ç§’
        slowRule.setTimeWindow(10);  // ç†”æ–­æ—¶é•¿10ç§’
        
        // å¼‚å¸¸æ¯”ä¾‹ç†”æ–­
        DegradeRule errorRule = new DegradeRule();
        errorRule.setResource("createOrder");
        errorRule.setGrade(CircuitBreakerStrategy.ERROR_RATIO.getType());
        errorRule.setCount(0.5);  // å¼‚å¸¸æ¯”ä¾‹50%
        errorRule.setMinRequestAmount(10);
        errorRule.setStatIntervalMs(10000);
        errorRule.setTimeWindow(10);
        
        rules.add(slowRule);
        rules.add(errorRule);
        
        DegradeRuleManager.loadRules(rules);
    }
}
```

## 5. ç¼“å­˜ç­–ç•¥ â­â­â­â­â­

### å¤šçº§ç¼“å­˜æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å®¢æˆ·ç«¯è¯·æ±‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    L1ç¼“å­˜ï¼šæœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰      â”‚  â† å‘½ä¸­ç‡é«˜ã€å»¶è¿Ÿä½
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ æœªå‘½ä¸­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    L2ç¼“å­˜ï¼šåˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisï¼‰       â”‚  â† å…±äº«ç¼“å­˜ã€å®¹é‡å¤§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ æœªå‘½ä¸­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    L3ç¼“å­˜ï¼šæ•°æ®åº“                    â”‚  â† æŒä¹…åŒ–å­˜å‚¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç¼“å­˜å®ç°

```java
@Service
public class ProductCacheService {
    
    // L1ç¼“å­˜ï¼šæœ¬åœ°ç¼“å­˜
    private final Cache<Long, Product> localCache = Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .build();
    
    // L2ç¼“å­˜ï¼šRedis
    @Autowired
    private RedisTemplate<String, Product> redisTemplate;
    
    // L3ï¼šæ•°æ®åº“
    @Autowired
    private ProductRepository productRepository;
    
    public Product getProduct(Long productId) {
        // 1. æŸ¥è¯¢L1ç¼“å­˜
        Product product = localCache.getIfPresent(productId);
        if (product != null) {
            return product;
        }
        
        // 2. æŸ¥è¯¢L2ç¼“å­˜
        String redisKey = "product:" + productId;
        product = redisTemplate.opsForValue().get(redisKey);
        if (product != null) {
            // å›å†™L1ç¼“å­˜
            localCache.put(productId, product);
            return product;
        }
        
        // 3. æŸ¥è¯¢æ•°æ®åº“
        product = productRepository.findById(productId)
            .orElseThrow(() -> new NotFoundException("å•†å“ä¸å­˜åœ¨"));
        
        // 4. å›å†™ç¼“å­˜
        redisTemplate.opsForValue().set(redisKey, product, 30, TimeUnit.MINUTES);
        localCache.put(productId, product);
        
        return product;
    }
}
```

### ç¼“å­˜é—®é¢˜è§£å†³æ–¹æ¡ˆ

**1. ç¼“å­˜ç©¿é€**

```java
// ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨
@Service
public class BloomFilterService {
    
    private final BloomFilter<Long> bloomFilter = BloomFilter.create(
        Funnels.longFunnel(),
        100000,  // é¢„æœŸå…ƒç´ æ•°é‡
        0.01     // è¯¯åˆ¤ç‡
    );
    
    @PostConstruct
    public void init() {
        // åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨
        List<Long> productIds = productRepository.findAllIds();
        productIds.forEach(bloomFilter::put);
    }
    
    public Product getProduct(Long productId) {
        // å…ˆåˆ¤æ–­æ˜¯å¦å¯èƒ½å­˜åœ¨
        if (!bloomFilter.mightContain(productId)) {
            throw new NotFoundException("å•†å“ä¸å­˜åœ¨");
        }
        
        // æŸ¥è¯¢ç¼“å­˜å’Œæ•°æ®åº“
        return productCacheService.getProduct(productId);
    }
}
```

**2. ç¼“å­˜å‡»ç©¿**

```java
// ä½¿ç”¨åˆ†å¸ƒå¼é”
@Service
public class ProductService {
    
    @Autowired
    private RedissonClient redissonClient;
    
    public Product getProduct(Long productId) {
        String cacheKey = "product:" + productId;
        
        // 1. æŸ¥è¯¢ç¼“å­˜
        Product product = redisTemplate.opsForValue().get(cacheKey);
        if (product != null) {
            return product;
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼Œä½¿ç”¨åˆ†å¸ƒå¼é”
        String lockKey = "lock:product:" + productId;
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…10ç§’ï¼Œé”30ç§’åè‡ªåŠ¨é‡Šæ”¾
            if (lock.tryLock(10, 30, TimeUnit.SECONDS)) {
                try {
                    // åŒé‡æ£€æŸ¥
                    product = redisTemplate.opsForValue().get(cacheKey);
                    if (product != null) {
                        return product;
                    }
                    
                    // æŸ¥è¯¢æ•°æ®åº“
                    product = productRepository.findById(productId)
                        .orElseThrow(() -> new NotFoundException("å•†å“ä¸å­˜åœ¨"));
                    
                    // å†™å…¥ç¼“å­˜
                    redisTemplate.opsForValue().set(cacheKey, product, 30, TimeUnit.MINUTES);
                    
                    return product;
                    
                } finally {
                    lock.unlock();
                }
            } else {
                // è·å–é”å¤±è´¥ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
                Thread.sleep(100);
                return getProduct(productId);
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new RuntimeException("è·å–é”è¢«ä¸­æ–­", e);
        }
    }
}
```

**3. ç¼“å­˜é›ªå´©**

```java
// è®¾ç½®éšæœºè¿‡æœŸæ—¶é—´
public void cacheProduct(Product product) {
    String cacheKey = "product:" + product.getId();
    
    // åŸºç¡€è¿‡æœŸæ—¶é—´30åˆ†é’Ÿ + éšæœº0-5åˆ†é’Ÿ
    int baseExpire = 30;
    int randomExpire = ThreadLocalRandom.current().nextInt(5);
    int totalExpire = baseExpire + randomExpire;
    
    redisTemplate.opsForValue().set(
        cacheKey, 
        product, 
        totalExpire, 
        TimeUnit.MINUTES
    );
}
```

## ğŸ’¡ æœ€ä½³å®è·µ

### é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡åŸåˆ™

```
1. æ— çŠ¶æ€è®¾è®¡
   - æœåŠ¡æ— çŠ¶æ€ï¼Œæ˜“äºæ‰©å±•
   - çŠ¶æ€å­˜å‚¨åœ¨ç¼“å­˜æˆ–æ•°æ®åº“

2. å¼‚æ­¥åŒ–
   - åŒæ­¥æ”¹å¼‚æ­¥
   - ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—
   - æé«˜ååé‡

3. ç¼“å­˜ä¼˜å…ˆ
   - å¤šçº§ç¼“å­˜
   - ç¼“å­˜é¢„çƒ­
   - ç¼“å­˜æ›´æ–°ç­–ç•¥

4. å‰Šå³°å¡«è°·
   - ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—
   - æµé‡æ•´å½¢
   - å¹³æ»‘å¤„ç†

5. é™æµä¿æŠ¤
   - æ¥å£é™æµ
   - ç”¨æˆ·é™æµ
   - IPé™æµ

6. é™çº§ç†”æ–­
   - éæ ¸å¿ƒåŠŸèƒ½é™çº§
   - æœåŠ¡ç†”æ–­ä¿æŠ¤
   - å¿«é€Ÿå¤±è´¥

7. ç›‘æ§å‘Šè­¦
   - å®æ—¶ç›‘æ§
   - åŠæ—¶å‘Šè­¦
   - å¿«é€Ÿå“åº”
```

## ğŸ¯ å®æˆ˜ç»ƒä¹ 

### ç»ƒä¹ 1ï¼šè®¾è®¡ç§’æ€ç³»ç»Ÿ

**éœ€æ±‚**ï¼š
- 10ä¸‡ç”¨æˆ·æŠ¢è´­100ä»¶å•†å“
- ä¿è¯ä¸è¶…å–
- å“åº”æ—¶é—´ < 500ms

**ä»»åŠ¡**ï¼š
1. è®¾è®¡ç³»ç»Ÿæ¶æ„
2. å®ç°é™æµç­–ç•¥
3. å®ç°ç¼“å­˜æ–¹æ¡ˆ
4. å®ç°é™çº§ç†”æ–­

## ğŸ“š ä¸‹ä¸€æ­¥å­¦ä¹ 

- [JVMæ€§èƒ½è°ƒä¼˜](./JVMæ€§èƒ½è°ƒä¼˜.md)
- [æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–](./æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–.md)
- [ç¼“å­˜æ¶æ„è®¾è®¡](./ç¼“å­˜æ¶æ„è®¾è®¡.md)

---

**æ­å–œä½ å®Œæˆäº†é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡çš„å­¦ä¹ ï¼** ğŸ‰

